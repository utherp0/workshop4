<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="author" content="Mark Roberts &lt;mroberts@redhat.com&gt;">
<title>DevEx Workshop - Essentials+</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>DevEx Workshop - Essentials+</h1>
<div class="details">
<span id="author" class="author">Mark Roberts</span><br>
<span id="email" class="email"><a href="mailto:mroberts@redhat.com">mroberts@redhat.com</a></span><br>
<span id="revnumber">version 1.0.0,</span>
<span id="revdate">July 13, 2020</span>
<br><span id="revremark"></span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#intro">Introduction</a>
<ul class="sectlevel2">
<li><a href="#attendee-details">Attendee details</a>
<ul class="sectlevel3">
<li><a href="#what-is-openshift">What is Openshift</a></li>
<li><a href="#links">Links</a></li>
<li><a href="#contributors">Contributors</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#workshop-pre-requisites">Workshop Pre-requisites</a>
<ul class="sectlevel2">
<li><a href="#setting-up-the-ui-and-terminal">Setting up the UI and Terminal</a></li>
</ul>
</li>
<li><a href="#introduction-to-oc-introduction">Introduction to 'oc' [INTRODUCTION]</a>
<ul class="sectlevel2">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#a-quick-overview-of-oc">A quick overview of 'oc'</a></li>
<li><a href="#creating-a-projectnamespace">Creating a Project/Namespace</a></li>
<li><a href="#adding-some-applications">Adding some Applications</a></li>
<li><a href="#using-oc-to-manipulate-existing-objects">Using oc to manipulate existing objects</a></li>
<li><a href="#using-jsonpath-to-extract-specific-object-values">Using jsonpath to extract specific object values</a></li>
<li><a href="#cleanup-the-lab">Cleanup the lab</a></li>
</ul>
</li>
<li><a href="#application-basics-introduction">Application Basics [INTRODUCTION]</a>
<ul class="sectlevel2">
<li><a href="#introduction-2">Introduction</a></li>
<li><a href="#starting-up-logging-on-and-creating-a-project">Starting up - logging on and creating a project</a></li>
<li><a href="#creating-your-first-application">Creating your first Application</a></li>
<li><a href="#adding-additional-applications">Adding additional Applications</a></li>
<li><a href="#interacting-with-openshift-through-the-command-line">Interacting with OpenShift through the Command Line</a></li>
<li><a href="#a-summary-of-application-interactions">A Summary of Application Interactions</a></li>
</ul>
</li>
<li><a href="#application-deployment-configurations-and-devops-approaches-essentials">Application Deployment Configurations and DevOps Approaches [ESSENTIALS]</a>
<ul class="sectlevel2">
<li><a href="#introduction-3">Introduction</a>
<ul class="sectlevel3">
<li><a href="#workshop-content">Workshop Content</a></li>
<li><a href="#creation-of-version-1">Creation of version 1</a></li>
<li><a href="#creation-of-version-2">Creation of version 2</a></li>
</ul>
</li>
<li><a href="#blue-green-deployment">Blue / Green Deployment</a></li>
<li><a href="#ab-deployment">A/B Deployment</a></li>
<li><a href="#url-based-routing">URL based routing</a>
<ul class="sectlevel3">
<li><a href="#creating-the-applications">Creating the applications</a></li>
<li><a href="#cleaning-up">Cleaning up</a></li>
</ul>
</li>
<li><a href="#introduction-4">Introduction</a></li>
<li><a href="#introducing-deployment-configurations">Introducing Deployment Configurations</a></li>
<li><a href="#dependency-injection-using-config-maps">Dependency Injection using Config Maps</a></li>
<li><a href="#dependency-injection-of-sensitive-information-using-secrets">Dependency Injection of sensitive information using Secrets</a></li>
<li><a href="#understanding-the-deployment-strategies">Understanding the Deployment Strategies</a>
<ul class="sectlevel3">
<li><a href="#cleaning-up-2">Cleaning up</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#healthprobes">Pod Health Probes [ESSENTIALS]</a>
<ul class="sectlevel2">
<li><a href="#introduction-5">Introduction</a></li>
<li><a href="#creating-the-project-and-application">Creating the project and application</a></li>
<li><a href="#viewing-the-running-application">Viewing the running application</a></li>
<li><a href="#liveness-probe">Liveness Probe</a>
<ul class="sectlevel3">
<li><a href="#activation-of-the-liveness-prove">Activation of the Liveness Prove</a></li>
</ul>
</li>
<li><a href="#readiness-probe">Readiness Probe</a>
<ul class="sectlevel3">
<li><a href="#activation-of-the-readiness-probe">Activation of the Readiness Probe</a></li>
<li><a href="#cleaning-up-3">Cleaning up</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#openshift-do-devtools">OpenShift DO [DEVTOOLS]</a>
<ul class="sectlevel2">
<li><a href="#introduction-6">Introduction</a></li>
<li><a href="#installing">Installing</a></li>
<li><a href="#odo-command-set">odo command set</a></li>
<li><a href="#logging-in">Logging in</a>
<ul class="sectlevel3">
<li><a href="#examining-source-assets">Examining source assets</a></li>
</ul>
</li>
<li><a href="#create-push-source-run-cycle">Create, push source &amp; run cycle</a></li>
<li><a href="#odo-watch">odo watch</a></li>
</ul>
</li>
<li><a href="#openshift-pipelines-tekton-innovation">OpenShift Pipelines - Tekton [INNOVATION]</a>
<ul class="sectlevel2">
<li><a href="#introduction-7">Introduction</a></li>
<li><a href="#tasks">Tasks</a>
<ul class="sectlevel3">
<li><a href="#download-pipeline-assets">Download pipeline assets</a></li>
<li><a href="#simple-task-creation-and-execution">Simple task creation and execution</a></li>
</ul>
</li>
<li><a href="#pipelines">Pipelines</a></li>
<li><a href="#viewing-pipelines-through-the-web-ui">Viewing pipelines through the Web UI</a></li>
<li><a href="#task-inputs">Task inputs</a>
<ul class="sectlevel3">
<li><a href="#task-input-example">Task input example</a></li>
</ul>
</li>
<li><a href="#workspaces-and-volumes">Workspaces and Volumes</a></li>
</ul>
</li>
<li><a href="#understanding-persistent-volumes-essentials">Understanding Persistent Volumes [ESSENTIALS]</a>
<ul class="sectlevel2">
<li><a href="#introduction-8">Introduction</a></li>
<li><a href="#setting-up-the-lab">Setting up the lab</a></li>
<li><a href="#adding-a-persistent-volume-to-an-application">Adding a Persistent Volume to an Application</a></li>
<li><a href="#storage-surviving-application-loss">Storage surviving Application loss</a></li>
<li><a href="#demonstrating-the-rwo-behaviour">Demonstrating the RWO behaviour</a></li>
<li><a href="#summary-and-clean-up">Summary and clean-up</a></li>
</ul>
</li>
<li><a href="#the-rbac-model-for-developers-essentials">The RBAC model for Developers [ESSENTIALS]</a>
<ul class="sectlevel2">
<li><a href="#introduction-9">Introduction</a></li>
<li><a href="#examining-service-accounts">Examining Service Accounts</a></li>
<li><a href="#adding-role-bindings-to-your-namespaceproject">Adding Role Bindings to your namespace/project</a></li>
<li><a href="#giving-users-lower-levels-of-permission">Giving Users lower levels of permission</a></li>
</ul>
</li>
<li><a href="#understanding-the-software-defined-network-essentials">Understanding the Software Defined Network [ESSENTIALS]</a>
<ul class="sectlevel2">
<li><a href="#introduction-10">Introduction</a></li>
<li><a href="#the-basics-of-service-addressing">The basics of Service Addressing</a></li>
<li><a href="#using-the-shorthand-service-name-directly">Using the shorthand Service name directly</a></li>
<li><a href="#using-the-fully-qualified-domain-name-for-accessing-services">Using the Fully Qualified Domain Name for accessing Services</a></li>
<li><a href="#controlling-access-through-network-policies">Controlling Access through Network Policies</a></li>
</ul>
</li>
<li><a href="#openshift-service-mesh-innovation">OpenShift Service Mesh [INNOVATION]</a>
<ul class="sectlevel2">
<li><a href="#introduction-11">Introduction</a>
<ul class="sectlevel3">
<li><a href="#istio">Istio</a></li>
<li><a href="#kiali">Kiali</a></li>
<li><a href="#jaeger">Jaeger</a></li>
</ul>
</li>
<li><a href="#using-red-hat-service-mesh">Using Red Hat Service Mesh</a>
<ul class="sectlevel3">
<li><a href="#create-a-new-project-for-the-service-mesh-activity">Create a new project for the service mesh activity</a></li>
</ul>
</li>
<li><a href="#phase-1-initial-application">Phase 1 - Initial application</a>
<ul class="sectlevel3">
<li><a href="#adding-istio-capability">Adding Istio capability</a></li>
<li><a href="#view-the-istio-related-resources">View the istio related resources</a></li>
</ul>
</li>
<li><a href="#service-mesh-visualisation-with-kiali">Service mesh visualisation with Kiali</a></li>
<li><a href="#phase-2-further-content-in-the-communication-chain">Phase 2 - Further content in the communication chain</a></li>
<li><a href="#phase-3-further-multi-versioned-applications-in-the-communication-chain">Phase 3 - Further multi-versioned applications in the communication chain</a></li>
<li><a href="#phase-4-service-timeout">Phase 4 - Service timeout</a>
<ul class="sectlevel3">
<li><a href="#introducing-application-delay">Introducing application delay</a></li>
</ul>
</li>
<li><a href="#cleaning-up-4">Cleaning up</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="intro"><a class="anchor" href="#intro"></a>Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="attendee-details"><a class="anchor" href="#attendee-details"></a>Attendee details</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-bottom"><div class="content"><div class="paragraph">
<p>Name:</p>
</div></div></td>
<td class="tableblock halign-left valign-bottom"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-bottom"><div class="content"><div class="paragraph">
<p>User ID (userX):</p>
</div></div></td>
<td class="tableblock halign-left valign-bottom"><div class="content"></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This workshop is designed to introduce Developers to <strong>OpenShift 4</strong> and explain the usage and technologies around it from a developer perspective.</p>
</div>
<div class="sect3">
<h4 id="what-is-openshift"><a class="anchor" href="#what-is-openshift"></a>What is Openshift</h4>
<div class="paragraph">
<p>Red Hat® OpenShift® is a hybrid cloud, enterprise, secure Kubernetes application platform.</p>
</div>
<div class="paragraph">
<p>OpenShift is an Enterprise strength, secure implementation of the Kubernetes container orchestration project with additional tooling designed to make the lives of Developer and Administrators as easy as possible.</p>
</div>
</div>
<div class="sect3">
<h4 id="links"><a class="anchor" href="#links"></a>Links</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.openshift.com/learn/what-is-openshift" target="_blank" rel="noopener">https://www.openshift.com/learn/what-is-openshift</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/OpenShift" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/OpenShift</a></p>
</li>
<li>
<p><a href="https://www.openshift.com/products/container-platform" target="_blank" rel="noopener">https://www.openshift.com/products/container-platform</a></p>
</li>
<li>
<p><a href="https://https" target="_blank" rel="noopener">https://https</a> (the Web Console URL for the Workshop)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="contributors"><a class="anchor" href="#contributors"></a>Contributors</h4>
<div class="paragraph">
<p>Red Hat UK DSA Team:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Phil Prosser</p>
</li>
<li>
<p>Mark Roberts</p>
</li>
<li>
<p>''Uther'' Lawson</p>
</li>
<li>
<p>Jonny Browning</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Original asciidoc documentation for DevEx3.x by Phillip Kruger, Red Hat CEMEA</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="workshop-pre-requisites"><a class="anchor" href="#workshop-pre-requisites"></a>Workshop Pre-requisites</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="setting-up-the-ui-and-terminal"><a class="anchor" href="#setting-up-the-ui-and-terminal"></a>Setting up the UI and Terminal</h3>
<div class="paragraph">
<p><strong>The workshop was designed and tested on the Chrome browser and it is advised to avoid issues that this browser be used whenever possible</strong></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For a number of the labs you will be interacting with the OpenShift cluster using a number of different command line tools. In order to avoid you having to install them on your own machine we have taken advantage of the nature of OpenShift and produced a Container that does it all for you, and provides a terminal experience in the browser. In this section you will create that application; this terminal is used throughout the workshop.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you leave the Terminal window open for a long time without using it it will disconnect. To reconnect simply refresh the page.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open the browser and navigate to the console url <a href="https://https" target="_blank" rel="noopener">https://https</a></p>
</div>
<div class="paragraph">
<p>Logon using the user provided by the course administrator (user*x* where <strong>x</strong> is a unique number for your session)</p>
</div>
<div class="paragraph">
<p>When logged on you will be presented with a screen listing the projects, of which there are currently none</p>
</div>
<div class="paragraph">
<p>Hit 'Create Project'</p>
</div>
<div class="paragraph">
<p>For 'Name' enter terminal*x*, where <strong>x</strong> is the same unique number from your UserID (user*X*)</p>
</div>
<div class="paragraph">
<p>'Display Name' and 'Description' are optional labels</p>
</div>
<div class="paragraph">
<p>Once the project has been created (you will be given a dashboard) change the mode of the UI from Administrator to Developer by clicking on the top left of the UI where it says 'Administrator' and selecting 'Developer'</p>
</div>
<div class="paragraph">
<p>On the Topology page it will state 'No workloads found' - Click on 'Container Image'</p>
</div>
<div class="paragraph">
<p>In 'Image Name' enter 'quay.io/ilawson/devex4'</p>
</div>
<div class="paragraph">
<p>Click on the search icon to the right of the text box</p>
</div>
<div class="paragraph">
<p>Leave everything else as default and scroll down to the bottom of the page. Hit 'Create'</p>
</div>
<div class="paragraph">
<p>Wait for the ring around the application icon to change to dark blue - this indicates the application has been started</p>
</div>
<div class="paragraph">
<p>In the topology page click on the 'Open URL' icon as shown below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/prereq-1.png" alt="Selecting the Open URL">
</div>
</div>
<div class="paragraph">
<p>This will open another tab with a command line in it - this is your terminal for the duration of the basic workshop</p>
</div>
<div class="paragraph">
<p>Switch back to the UI and click on the userx displayed at the top right and select 'Copy Login Command' as shown below</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/prereq-2.png" alt="Selecting Copy Login"></span></p>
</div>
<div class="paragraph">
<p>In the new tab that appears login with your userx (unique number instead of x) and password 'openshift'</p>
</div>
<div class="paragraph">
<p>Click on 'Display Token'</p>
</div>
<div class="paragraph">
<p>Copy the command given for 'Log in with this token' - this may require using the browser 'copy' command after highlighting the command</p>
</div>
<div class="paragraph">
<p>Close this tab and switch to the terminal tab - if you have closed the terminal tab go back to the UI and select the 'Show URL' from the topology view in the Developer UI</p>
</div>
<div class="paragraph">
<p>Paste and execute the command</p>
</div>
<div class="paragraph">
<p>Press 'y' to use insecure connections</p>
</div>
<div class="paragraph">
<p>The terminal should now be logged on - to check it try</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc whoami
oc version</code></pre>
</div>
</div>
<div class="paragraph">
<p>The terminal should display your user for the first command and the client and Kubernetes versions for the second command</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction-to-oc-introduction"><a class="anchor" href="#introduction-to-oc-introduction"></a>Introduction to 'oc' [INTRODUCTION]</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Ian Lawson (feedback to <a href="mailto:ian.lawson@redhat.com">ian.lawson@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h3>
<div class="paragraph">
<p>This lab introduces the command line interface to OpenShift, 'oc', and the concepts of the interactions you can have with the OpenShift system through it.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The attendee will be using the terminal application created in the pre-requisites step (for command line exercises). It is strongly suggested the attendee uses Chrome or Firefox. All of this lab is done with the terminal.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="a-quick-overview-of-oc"><a class="anchor" href="#a-quick-overview-of-oc"></a>A quick overview of 'oc'</h3>
<div class="paragraph">
<p>OpenShift is built around Kubernetes, which is a fantastically complex and elegant orchestration system for containers. It works by maintaining a state vision of the entire system, which is a set of what are called 'objects'.</p>
</div>
<div class="paragraph">
<p>An 'object' has a type - i.e. Service, Pod, User, Namesapce and the like. This type tells Kubernetes how and what it can do with the object; in fact Kubernetes has a number of processes called 'controllers' whose only job is to create, monitor and maintain these 'objects'.</p>
</div>
<div class="paragraph">
<p>In order for a user to interact with the system, be it OpenShift or Kubernetes, an API is provided that allows you to create, manipulate and remove these objects. But it&#8217;s very complicated, because of the nature of the systems.</p>
</div>
<div class="paragraph">
<p>So, for Kubernetes, there is a command line utility created called 'kubectl'. OpenShift&#8217;s own command line, 'oc', derives from this utility but adds the extra features, and access to the additional objects that OpenShift offers above and beyond Kubernetes.</p>
</div>
<div class="paragraph">
<p>What we will be doing in this lab is using the oc client to work with OpenShift from a developers perspective. OpenShift provides a number of ways that you can interact with it; for example the Developer UI, the Administration UI, odo. But oc is the most powerful because it exposes the entire set of objects through the RESTful API provided.</p>
</div>
<div class="paragraph">
<p>You will find that, once you understand the nature of the underlying objects and the way you can interact with them, that 'oc' is a fantastic tool for developers wanting to use OpenShift to orchestrate their applications.</p>
</div>
</div>
<div class="sect2">
<h3 id="creating-a-projectnamespace"><a class="anchor" href="#creating-a-projectnamespace"></a>Creating a Project/Namespace</h3>
<div class="paragraph">
<p>Let&#8217;s start by going to the terminal window as defined in the pre-requisites. To make sure we are working in the correct context type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc whoami
oc version</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ocintro1.png" alt="Correct response from oc">
</div>
</div>
<div class="paragraph">
<p>The oc client works using something called a 'context'. This is a valid login to a target OpenShift system. If the commands do not return the successful output (see above for a similar output) then please repeat the login steps listed in the pre-requisites.</p>
</div>
<div class="paragraph">
<p>What we are going to do is create a Project to work in. This is equivalent, but not the same as, the Kubernetes 'namespace'. Type the following (remembering to replace the 'x' in the name with your user number):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-project octestx</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ocintro2.png" alt="Correct response from oc new-project">
</div>
</div>
<div class="paragraph">
<p>What we have done is create a context within our user&#8217;s object space on the OpenShift Cluster. As creators we have admin access and rights to this space - we can create and delete objects, that we have the rights to create, as much as we like here.</p>
</div>
<div class="paragraph">
<p>Now type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc projects
oc get projects</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ocintro3.png" alt="Correct response from projects commands">
</div>
</div>
<div class="paragraph">
<p>The 'oc projects' is an opinionated command - because we work with Projects so much there is a shortcut for them. The second command is the standard way of getting any object that you have the rights to via the oc command.</p>
</div>
<div class="paragraph">
<p>Now type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc api-resources</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command goes to the OpenShift Cluster and gets a list of the all the object types/resources you can see. There are a lot of them. Try this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc explain pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will show an explanation of that API object type, namely 'Pods'. Now the cool bit - type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc explain pods --recursive</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ocintro4.png" alt="Full definition of Pod">
</div>
</div>
<div class="paragraph">
<p>Every object can be described using JSON or YAML - this command returns, from the Server, the exact definition of that object. This is incredibly useful when we get to editing the objects via oc.</p>
</div>
</div>
<div class="sect2">
<h3 id="adding-some-applications"><a class="anchor" href="#adding-some-applications"></a>Adding some Applications</h3>
<div class="paragraph">
<p>OpenShift works with the concept of 'Applications'. An Application translates, in OpenShift speak, to all the object components needed to build and deploy an Application in a Container, and orchestrate that Application appropriately (multiple copies of the Container, configuration settings and the like).</p>
</div>
<div class="paragraph">
<p>If we started at absolute basics and created all the objects we need for an Application in OpenShift we would have a number of things to remember to created. This would include:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A BuildConfig, which describes how to build the Image that will contain our Application</p>
</li>
<li>
<p>A Build, which is the actual task that executes the BuildConfig, in a Pod, to generate our Application Image</p>
</li>
<li>
<p>A Service, which is the IP endpoint for the Application within the OpenShift Cluster</p>
</li>
<li>
<p>An ImageStream, which is a wrapper around the created Image.</p>
</li>
<li>
<p>A DeploymentConfig, which tells OpenShift how to physically orchestrate the Application</p>
</li>
<li>
<p>A Route, which provides the external connectivity into the Application</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Fortunately we can shortcut this as developers, if we have, for example, a GitHub repo with existing code. Type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-app https://github.com/utherp0/meow2</code></pre>
</div>
</div>
<div class="paragraph">
<p>The oc command will cause OpenShift to create all the contents it needs for an Application based on the source code it finds at the GitHub repo. In this case the source code contains the building blocks for a node.js application. The image belows shows the output you should receive:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/ocintro5.png" alt="Result of new-app"></span></p>
</div>
<div class="paragraph">
<p><strong>Note the Resources Created part of the output - from a single command to create an App it has created the core required components.</strong></p>
</div>
<div class="paragraph">
<p>Now type the follow, as suggested by the output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc status</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ocintro6.png" alt="oc status output">
</div>
</div>
<div class="paragraph">
<p>The system is performing a build, defined by the buildconfig that has been created using the chosen technology deduced by OpenShift from the repo. When the build finishes it will deploy the application - the deployment is shown as the 'dc', which is the deployment config object. This is waiting on the image to be created by the build. It also creates a Service, which is the internal endpoint for the application.</p>
</div>
<div class="paragraph">
<p>If you wait a little (feel free to repeat the 'oc status' command) the build will complete and the application will be deployed. You can check for when it deploys by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once deployed the output should look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ocintro7.png" alt="working pods">
</div>
</div>
<div class="paragraph">
<p>You will notice there are three Pods - two have completed and one is running. This is because those actions of building an Application into an Image and then deploying the Application are executed as Pods themselves.</p>
</div>
<div class="paragraph">
<p>Now, for the sake of the lab, we will create a second application. Type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-app https://github.com/utherp0/nodenews</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again use the 'oc get pods' and 'oc status' to watch the build of the second application. When it completes it will look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ocintro8.png" alt="working pods for app2">
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-oc-to-manipulate-existing-objects"><a class="anchor" href="#using-oc-to-manipulate-existing-objects"></a>Using oc to manipulate existing objects</h3>
<div class="paragraph">
<p>Now we will show the power of the oc command. First, type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pods | grep Running</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will list the Pods running, i.e. the applications. We will now scale the 'meow2' application to three Pods and the 'nodenews' application to two Pods. Type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc scale dc/meow2 --replicas=3
oc scale dc/nodenews --replicas=2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the commands come back successfully type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pods | grep Running</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ocintro9.png" alt="all the pods for the two apps">
</div>
</div>
<div class="paragraph">
<p>We are now going to look at the composition of a single 'object', in this case a pod. Using the output of the command above, pick one of the three Running meow2 Pods. You will need the name, which will be meow2-1-xxxxx, where xxxxx are random characters. Using the five characters from your chosen Pod type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pod meow2-1-[PUT YOUR CHOSEN POD'S CHARACTERS HERE]</code></pre>
</div>
</div>
<div class="paragraph">
<p>That will give you a simple overview of the object, in this case the Pod. Now type this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pod meow2-1-[PUT YOUR CHOSEN POD'S CHARACTERS HERE] -o json</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will get a huge amount of information. What this command has done is returned the entire object in JSON. Now type this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pod meow2-1-[PUT YOUR CHOSEN POD'S CHARACTERS HERE] -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you will see the entire object listed in YAML. This is the complete object from OpenShift/Kubernetes, so as well as seeing the definition, which is all the components under 'spec:', you will also see the metadata for the object, listed under 'metadata:' and the current status of the object, listed under 'status:'.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-jsonpath-to-extract-specific-object-values"><a class="anchor" href="#using-jsonpath-to-extract-specific-object-values"></a>Using jsonpath to extract specific object values</h3>
<div class="paragraph">
<p>One of the supported output formats from certain oc commands is 'jsonpath'. This uses the functionally rich XPath syntax to reformat the output. A good introduction to this is available at <a href="https://restfulapi.net/json-jsonpath/">https://restfulapi.net/json-jsonpath/</a></p>
</div>
<div class="paragraph">
<p>And this is where the oc command becomes incredibly powerful. Type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get dc -o jsonpath='{.items[*].metadata.name}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the output of an object in json through a jsonpath filter and access <strong>any</strong> component of the object. Here&#8217;s a more useful example - type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>for pod in $(oc get pods -o jsonpath='{.items[*].metadata.name}'); \
do echo $pod; \
echo "  "$(oc get pod $pod -o jsonpath='{.status.phase}'); \
done</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ocintro10.png" alt="manual pod listing">
</div>
</div>
<div class="paragraph">
<p>What we will do now is to scale down <strong>all</strong> of the applications to a single Pod using the oc command - this may seem a little pithy but imagine if you had operations to run over hundreds or thousands of objects. This approach makes it very easy to automate tasks. Type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>for dc in $(oc get dc -o jsonpath='{.items[*].metadata.name}'); \
do oc scale dc/$dc --replicas=1; \
done

oc get pods | grep Running</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will scale <strong>all</strong> of the deployment configs to one copy.</p>
</div>
<div class="paragraph">
<p>The oc command gives access to <strong>all</strong> the objects available for the logged on User. In the case of a standard user, such as the one we are using for this lab, this will be the objects created in the namespace. In the case of what is called a 'Cluster Admin' user this is effectively all the objects in the entire system.</p>
</div>
</div>
<div class="sect2">
<h3 id="cleanup-the-lab"><a class="anchor" href="#cleanup-the-lab"></a>Cleanup the lab</h3>
<div class="paragraph">
<p>We will finally use the oc command to clean the project. Type the following, replacing the x with your user number (i.e. octest84):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc delete project octestx</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="application-basics-introduction"><a class="anchor" href="#application-basics-introduction"></a>Application Basics [INTRODUCTION]</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Ian Lawson (feedback to <a href="mailto:ian.lawson@redhat.com">ian.lawson@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction-2"><a class="anchor" href="#introduction-2"></a>Introduction</h3>
<div class="paragraph">
<p>This chapter will introduce the attendee to the mechanics of creating and manipulating Applications using OpenShift Container Platform. It will introduce the two distinct contexts of the User Interface, the Administrator and Developer views, and guide the attendee through creating some Applications.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The attendee will be using a browser for interacting with both the OpenShift Container Platform UI and the terminal application created in the pre-requisites step (for command line exercises). It is strongly suggested the attendee uses Chrome or Firefox.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="starting-up-logging-on-and-creating-a-project"><a class="anchor" href="#starting-up-logging-on-and-creating-a-project"></a>Starting up - logging on and creating a project</h3>
<div class="paragraph">
<p>Log on to cluster at <a href="https://https" target="_blank" rel="noopener">https://https</a> as 'userx', where x is the number assigned to you by the course administrator, password 'openshift'</p>
</div>
<div class="paragraph">
<p>Ensure you are on the Administrator View - at the top left of the UI is a selection box which describes the current view selected.</p>
</div>
<div class="paragraph">
<p><strong>The Administrator view provides you with an extended functionality interface that allows you to deep dive into the objects available to your user. The Developer view is an opinionated interface designed to ease the use of the system for developers. This workshop will have you swapping between the contexts for different tasks.</strong></p>
</div>
<div class="paragraph">
<p>Click on 'Create Project'</p>
</div>
<div class="paragraph">
<p>Name - ‘sandboxX’ where x is user number</p>
</div>
<div class="paragraph">
<p>The Display Name and Description components are cosmetic labels and can be left empty. Hit 'Create'</p>
</div>
<div class="paragraph">
<p>When the project completes creation click on the 'Role Bindings' tab</p>
</div>
<div class="paragraph">
<p><strong>By default when you create a Project within OpenShift your user is given administration rights. This allows the user
to create any objects that they have rights to create and to change the security and access settings for the project
itself, i.e. add users as Administrators, Edit Access, Read access or disable other user&#8217;s abilities to even see
the project and the objects within.</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="creating-your-first-application"><a class="anchor" href="#creating-your-first-application"></a>Creating your first Application</h3>
<div class="paragraph">
<p>In the top left of the UI, where the label indicates the view mode, change the mode from Administrator to Developer</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/applicationbasics-2.png" alt="Developer Context">
</div>
</div>
<div class="paragraph">
<p>Click 'Add'</p>
</div>
<div class="paragraph">
<p><strong>The Catalog screen for the developer combines all the ways components can be added into the Project. These are:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>From Git - this provides another way to do a Source-2-Image build by first choosing the Git repo and then the builder image to use</strong></p>
</li>
<li>
<p><strong>Container Image - this provides a way to directly deploy an Image from a repository</strong></p>
</li>
<li>
<p><strong>From Catalog - this allows the Developer to browse all available templates, which are predefined sets of Objects to create an application</strong></p>
</li>
<li>
<p><strong>From Dockerfile - this allows the Developer to do a controlled build of an Image from a Dockerfile</strong></p>
</li>
<li>
<p><strong>YAML - this allows the Developer to provide a set of populated YAML to define the objects to be added to the Project</strong></p>
</li>
<li>
<p><strong>Database - this allows the Developer to browse pre-created Database services to add to the Project</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Select ‘From Catalog’</p>
</div>
<div class="paragraph">
<p>Enter ‘node’ in the search box</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/applicationbasics-1.png" alt="Node Choice">
</div>
</div>
<div class="paragraph">
<p><strong>OpenShift allows for multiple base images to be built upon - the selection of node searches for any images or templates registered into the system
with the label 'node'. In the screenshot above, and in the catalog you will be presented with, there will be a selection of base images.</strong></p>
</div>
<div class="paragraph">
<p>Select ‘Node.js’</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/applicationbasics-3.png" alt="Node Choice">
</div>
</div>
<div class="paragraph">
<p><strong>When you select an option, in this case the Node.js builder one, you are presented with a wizard that shows you exactly what
components will be created as part of your Project. In this case, with Node.js, the template will create a build config, that will build the
Image that will contain your Application, an ImageStream which is the OpenShift representation of an Image, a deployment config, which defines exactly how the image
will be deployed as a running Container within the Project, a service which is the internal endpoint for the application within the Project and a route,
optionally, which will provide access to the Application for external consumers.</strong></p>
</div>
<div class="paragraph">
<p>Click on 'Create Application'</p>
</div>
<div class="paragraph">
<p><strong>This approach uses the OpenShift ''source-2-image'' concept, which is a controlled mechanism provided by OpenShift that automates the creation
of application images using a base image and a source repository.</strong></p>
</div>
<div class="paragraph">
<p>Change the Builder Image Version to 8</p>
</div>
<div class="paragraph">
<p><strong>The ''source-2-image'' approach allows you to use differing versions of a base image - in this case you can execute the Node build against a number of supported Node
versions.</strong></p>
</div>
<div class="paragraph">
<p>Enter the following for the Git repo for the application - <a href="https://github.com/utherp0/nodenews" target="_blank" rel="noopener">https://github.com/utherp0/nodenews</a></p>
</div>
<div class="paragraph">
<p>In a separate browser tab go to <a href="https://github.com/utherp0/nodenews" target="_blank" rel="noopener">https://github.com/utherp0/nodenews</a></p>
</div>
<div class="paragraph">
<p><strong>If you visit the URL you will see there is no OpenShift specific code in the repository at all.</strong></p>
</div>
<div class="paragraph">
<p>Close the github tab</p>
</div>
<div class="paragraph">
<p>Back at the OCP4.3 UI click on the 'Application Name' entry box. It will auto-fill with the Application Name and the Name will auto-fill as well.</p>
</div>
<div class="paragraph">
<p><strong>OpenShift 4 introduces the concept of Application Grouping. This allows a visualisation of multiple Applications in the same 'group', making visibility of the Application much
simpler.</strong></p>
</div>
<div class="paragraph">
<p>Ensure the application name is ‘nodenews-app’</p>
</div>
<div class="paragraph">
<p>Ensure the Name is ‘nodenews’</p>
</div>
<div class="paragraph">
<p>Scroll down to 'Resources'. Click the selection box for 'Deployment Config' rather than the default of 'Deployment'</p>
</div>
<div class="paragraph">
<p><strong>OpenShift supports the Kubernetes mechanism of 'Deployment' but DeploymentConfigs are more advanced and offer more features for deploying an application, including strategies.</strong></p>
</div>
<div class="paragraph">
<p>Ensure the ‘Create Route is checked’</p>
</div>
<div class="paragraph">
<p>Click 'Create'</p>
</div>
<div class="paragraph">
<p><strong>The Topology view is a new feature of OpenShift 4 that provides a dynamic and useful visualisation of all of your Applications in a given Project.</strong></p>
</div>
<div class="paragraph">
<p>Click on the Icon marked 'Node'</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/applicationbasics-4.png" alt="Node Sidepanel">
</div>
</div>
<div class="paragraph">
<p><strong>The side-panel contains an overview of the Application you chose. In this case it will cover
the build. Once a build has completed this side panel shows the Pods that are running, the builds that have completed, the services
exported for the Application and the routes, if the Application has any.</strong></p>
</div>
<div class="paragraph">
<p>Wait for the Build to finish, the Pod to change from Container Creating to Running</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/applicationbasics-4b.png" alt="Node Sidepanel with App Running">
</div>
</div>
<div class="paragraph">
<p><strong>When an Application is created the Pod ring will be empty, indicating that an Application will appear once the build has completed. When the build
completes the Pod ring will switch to light blue, indicating the Pod is being pulled (the image is being pulled from the registry to the Node where the
Pod will land) and is starting (the Pod is physically in place but the Containers within it are not reporting as ready). Once the Pod is placed and running the colour
of the Pod ring will change to dark blue.</strong></p>
</div>
<div class="paragraph">
<p>Click on the Tick at the bottom left of the Pod</p>
</div>
<div class="paragraph">
<p><strong>If you scroll the log of the Build output you will see the steps that the build takes. This includes laying the foundational file layers for the base
image, performing the code specific build operations (in this case an ''npm install'') and then pushing the file layers for the image into the OpenShift
integrated registry.</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="adding-additional-applications"><a class="anchor" href="#adding-additional-applications"></a>Adding additional Applications</h3>
<div class="paragraph">
<p>Click 'Add+'</p>
</div>
<div class="paragraph">
<p>Click 'From Catalog'</p>
</div>
<div class="paragraph">
<p>Search for ‘httpd’</p>
</div>
<div class="paragraph">
<p>Select the Apache HTTP Server (httpd) template - Note that there are two options, you want to choose the one that is labelled (httpd) and starts with the text 'Build and serve static content'</p>
</div>
<div class="paragraph">
<p>Click on 'Create Application'</p>
</div>
<div class="paragraph">
<p>Leave Image Version as 2.4</p>
</div>
<div class="paragraph">
<p>Enter the following for the Git repo for the application - <a href="https://github.com/utherp0/forumstaticassets" target="_blank" rel="noopener">https://github.com/utherp0/forumstaticassets</a></p>
</div>
<div class="paragraph">
<p>Make sure the Application is ‘nodenews-app’</p>
</div>
<div class="paragraph">
<p>Click on the entry point for 'Name' - it should autofill</p>
</div>
<div class="paragraph">
<p>Make sure the Name is forumstaticassets</p>
</div>
<div class="paragraph">
<p>In the Resources section leave the Deployment as 'Deployment'</p>
</div>
<div class="paragraph">
<p>Make sure the ‘Create a Route’ checkbox is clicked</p>
</div>
<div class="paragraph">
<p>Click 'Create'</p>
</div>
<div class="paragraph">
<p><strong>Note that the new Application icon appears within a bounded area on the Topology page labelled with the 'Application' chosen above. If you click on the area between the Pods you can move
the group as a single action.</strong></p>
</div>
<div class="paragraph">
<p>Click on the forumstaticassets Pod</p>
</div>
<div class="paragraph">
<p>Watch the build complete, the Container Creating and the Running event.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/applicationbasics-4c.png" alt="Multi-app topology">
</div>
</div>
<div class="paragraph">
<p>Click 'Add'</p>
</div>
<div class="paragraph">
<p>Click 'From Catalog'</p>
</div>
<div class="paragraph">
<p>Search for ‘node’</p>
</div>
<div class="paragraph">
<p>Select ‘Node.js’</p>
</div>
<div class="paragraph">
<p>Click 'Create Application'</p>
</div>
<div class="paragraph">
<p>Leave at Builder Image Version 10</p>
</div>
<div class="paragraph">
<p>Enter the following for the Git repo for the application - <a href="https://github.com/utherp0/ocpnode" target="_blank" rel="noopener">https://github.com/utherp0/ocpnode</a></p>
</div>
<div class="paragraph">
<p>In the ‘Application’ pulldown select ‘Create Application‘</p>
</div>
<div class="paragraph">
<p>In the ‘Application Name’ enter ‘ocpnode-app’</p>
</div>
<div class="paragraph">
<p>Ensure the Name is ‘ocpnode’</p>
</div>
<div class="paragraph">
<p>In 'Resources' set the deployment type to DeploymentConfig</p>
</div>
<div class="paragraph">
<p>Ensure the ‘Create Route’ is checked</p>
</div>
<div class="paragraph">
<p>Click 'Create'</p>
</div>
<div class="paragraph">
<p>Click on the ‘ocpnode’ Application in the topology - click on the <span class="image"><img src="images/expand-arrows.png" alt="cross"></span> icon (if you hang over it it will say 'Fit To Screen') situated at the bottom left of the Topology panel to centralise the topology</p>
</div>
<div class="paragraph">
<p><strong>Now we have created a new Application grouping you will see two ''cloud'' groupings, labelled with the appropriate Application name you entered.</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/applicationbasics-4d.png" alt="Multi-app topology">
</div>
</div>
</div>
<div class="sect2">
<h3 id="interacting-with-openshift-through-the-command-line"><a class="anchor" href="#interacting-with-openshift-through-the-command-line"></a>Interacting with OpenShift through the Command Line</h3>
<div class="paragraph">
<p>With the OpenShift Enterprise command line interface (CLI), you can create applications and manage OpenShift projects from a terminal.
The CLI is ideal in situations where you are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Working directly with project source code.</p>
</li>
<li>
<p>Scripting OpenShift Enterprise operations.</p>
</li>
<li>
<p>Restricted by bandwidth resources and cannot use the web console.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As part of the pre-requisites for the workshop we created and started a terminal app. Go to that tab now (if you have closed it go back to the pre-reqs and follow the instructions for opening it).</p>
</div>
<div class="paragraph">
<p>Make sure <code>oc</code> is working, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc whoami
oc version</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Also see the <strong>Command-Line Reference</strong>: <a href="https://docs.openshift.com/container-platform/4.2/cli_reference/openshift_cli/getting-started-cli.html" target="_blank" rel="noopener">https://docs.openshift.com/container-platform/4.2/cli_reference/openshift_cli/getting-started-cli.html</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To explore the command line further execute the following commands and observe the results.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Change the X at the end of sandbox to your user number
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc projects
oc project sandboxX</code></pre>
</div>
</div>
<div class="paragraph">
<p>User should now be using the sandboxX project created and configured earlier</p>
</div>
<div class="paragraph">
<p>Next we will try a command that will fail because of OpenShift&#8217;s security controls</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get users</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>There is a level of permission within the OpenShift system called ''Cluster Admin''. This permission allows a User to access any of the objects on the
system regardless of Project. It is effectively a super-user and as such normal users do not normally have this level of access.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>If you look carefully at the Pods shown you will notice there are additional Pods above and beyond the ones expected for your Applications. If you look at the state of
these Pods they will be marked as Completed. Everything in OpenShift is executed as a Pod, including Builds. These completed Pods are the Builds we have run so far.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pods | grep Completed</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pods | grep Running</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get dc</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>DC is an abbreviation for Deployment Config. These are Objects that directly define how an Application is deployed within OpenShift. This is the ''ops''
side of the OpenShift system. Deployment Configs are different to Kubernetes Deployments in that they are an extension and contain things such as Config Maps, Secrets,
Volume Mounts, labelled targetting of Nodes and the like.</strong></p>
</div>
<div class="paragraph">
<p>Enter the command below to tell OpenShift to scale the number of instances of the Deployment Config 'nodenews' to two rather than the default one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc scale dc/nodenews --replicas=2</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="a-summary-of-application-interactions"><a class="anchor" href="#a-summary-of-application-interactions"></a>A Summary of Application Interactions</h3>
<div class="paragraph">
<p>Go back to the UI and make sure you are on Developer mode. Click on Topology.</p>
</div>
<div class="paragraph">
<p>Click on the ‘nodenews’ application</p>
</div>
<div class="paragraph">
<p>Note the ‘DC’ reference to the application under the icon</p>
</div>
<div class="paragraph">
<p>In the pop-up panel on the right click on 'Resources'</p>
</div>
<div class="paragraph">
<p>Note that there are two pods running with the application now</p>
</div>
<div class="paragraph">
<p>Change the mode from Developer to Administrator</p>
</div>
<div class="paragraph">
<p>Select the 'sandboxx' project in the project list</p>
</div>
<div class="paragraph">
<p>Note the metrics for the project</p>
</div>
<div class="paragraph">
<p>Click on 'Workloads' on the left menu (not the project overview) and then select Pods to see the list of pods for the project as shown in the image below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/applicationbasics-7.png" alt="Command Line Tools">
</div>
</div>
<div class="paragraph">
<p>It is possible to filter groups of pods that are displayed based on the headings of Running, Pending, Terminating etc. The classifications in dark blue are currently being displayed and those in grey are not being displayed. Click on the 'Completed' heading to switch on the display of completed pods (there should be five). Click on 'Running' to toggle the display of running pods off. Click on the appropriate headings again to switch off the display of completed pods and to switch back on the display of running pods.</p>
</div>
<div class="paragraph">
<p><strong>Note that all the builds and deployments you have done, for the deployments that have a DeploymentConfig, have completed Pods. All of the actions are executed in separate Pods which is one of the key features that makes OpenShift so scalable</strong></p>
</div>
<div class="paragraph">
<p>Change to Developer mode and then select Topology if the Topology page isn’t already shown</p>
</div>
<div class="paragraph">
<p>Hold down the shift button, click and hold on the forumstaticassets icon, and pull it out of the application grouping graphic. Release the hold on the forumstaticassets icon.</p>
</div>
<div class="paragraph">
<p><strong>The UI will now prompt you if you wish to remove the application component. Select Remove. This component is now separated from the application group</strong></p>
</div>
<div class="paragraph">
<p>Now hold down the shift button again, click and hold on the free floating forumstaticassets icon, and drag back over the boundary displayed for the nodenews-app application group. Release the hold and the application should be re-grouped.</p>
</div>
<div class="paragraph">
<p>Continue on with the Deployments chapter, which uses the applications created here to show the capabilities of the deployment configuration and how to alter the behaviour and file system of a Container without changing the image.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="application-deployment-configurations-and-devops-approaches-essentials"><a class="anchor" href="#application-deployment-configurations-and-devops-approaches-essentials"></a>Application Deployment Configurations and DevOps Approaches [ESSENTIALS]</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Mark Roberts (feedback to <a href="mailto:mroberts@redhat.com">mroberts@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction-3"><a class="anchor" href="#introduction-3"></a>Introduction</h3>
<div class="paragraph">
<p><strong>DevOps is a much overloaded term that is used to describe a variety of concepts in the creation of modern applications. In a simple definition DevOps is concerned with the interface between development practices used for the creative elements of software engineering and the procedural rigour of operationally running applications in production. Clearly these concepts have different objectives so it is important for teams (whether tasked with development or operations) to have a good understanding of the concepts, objectives and concerns of their counterparts on the other side of the fence.</strong></p>
</div>
<div class="paragraph">
<p><strong>In terms of this workshop it is important to highlight the  capabilities of containerized platforms with respect to the roll out of new versions of applications and how they get introduced to production and to end users. Terms such as blue/green deployments, black and white deployments, A/B deployments and canary deployments are used in various text books on 'DevOps' principles and some of these areas will be used in this chapter of the workshop.</strong></p>
</div>
<div class="paragraph">
<p>The activities in this workshop will introduce a new version of a simple application to use in two different manners.</p>
</div>
<div class="sect3">
<h4 id="workshop-content"><a class="anchor" href="#workshop-content"></a>Workshop Content</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The application to be used in this workshop is a simple NodeJS REST interface. Version 1 exists on the master branch of the GIT Repository and version 2 exists on the experimental branch.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To begin the creation of the application use the following commands in an command line window. :</p>
</div>
</div>
<div class="sect3">
<h4 id="creation-of-version-1"><a class="anchor" href="#creation-of-version-1"></a>Creation of version 1</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-project simple-rest-X</code></pre>
</div>
</div>
<div class="paragraph">
<p>(Where X is your user number)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-app --name simple-rest-app-v1-0  https://github.com/marrober/simpleRest.git

oc expose service simple-rest-app-v1-0 --name="simple-rest-app-route"</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What was added to the project ?</div>
<div class="paragraph">
<p>It is important to understand the resources and content that are created by the above commands within OpenShift:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A new project is created called simple-rest-X.</p>
</li>
<li>
<p>A deployment configuration is created called simple-rest-app-v1-0.</p>
</li>
<li>
<p>A replication controller is created associated with the application and the built objects. This defines the scaling of the application in terms of the number of pods and the deployment strategy (rolling or recreate).</p>
</li>
<li>
<p>A build configuration is created to compile the application source code which is extracted from the associated GIT repository.</p>
</li>
<li>
<p>The build configuration will create a build instance which includes logs of the build process and a reference to the built image.</p>
</li>
<li>
<p>The newly created image is deployed as a running pod (or pods depending on the number of pods defined in the deployment configuration).</p>
</li>
<li>
<p>A service is created as part of the application creation process. The service endpoints will point to the pod(s) created by the build process. In the case of a rebuild and redeploy operation the service endpoints are updated to point to the new pods in accordance with the deployment strategy of the deployment configuration.</p>
</li>
<li>
<p>The service is then exposed external to the cluster by the creation of a route. The route has a fully qualified domain name for access from machines outside the cluster.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The diagram below shows the above and how they relate together.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/deployment-strategies-1.png" alt="Deployment artefacts">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To identify the URL of the route execute the command shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get route simple-rest-app-route -o jsonpath='{"http://"}{.spec.host}{"/ip\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will display a formatted URL with the 'http://' part at the beginning which will be similar to :</p>
</div>
<div class="paragraph">
<p>http://simple-rest-app-route-simple-rest.apps.cluster-xxxx-yyyy.xxxx-yyyy.example.opentlc.com/ip</p>
</div>
<div class="paragraph">
<p>To test the application use the command line window to issue a curl command to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl &lt;url from the above command&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response should be as shown below (example ip address) :</p>
</div>
<div class="paragraph">
<p>"10.131.0.114 v1.0"</p>
</div>
</div>
<div class="sect3">
<h4 id="creation-of-version-2"><a class="anchor" href="#creation-of-version-2"></a>Creation of version 2</h4>
<div class="paragraph">
<p>The development team now wants to introduce an experimental version 2 of the application and introduce it to the users in a number of different ways. The first action is to create the new build process for the experimental version using the command below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-app --name simple-rest-app-v2-0 https://github.com/marrober/simpleRest.git#experimental</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note the use of the #experimental branch identifier in the end of the GIT repository. This syntax cannot be used through the web interface to OpenShift so any requirements for non-standard GIT connectivity must be done through the command line interface. It is also possible to configure the source-2-image capability to reference a specific sub directory of the repository using the --context option.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What was added to the project ?</div>
<div class="paragraph">
<p>New content was added to the project as a result of the above command specific to the experimental (v2) version of the application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A deployment configuration</p>
</li>
<li>
<p>A replication controller</p>
</li>
<li>
<p>A build configuration</p>
</li>
<li>
<p>A running container in a pod</p>
</li>
<li>
<p>A service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The diagram below shows the above and how they relate together.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/deployment-strategies-2.png" alt="Deployment artefacts">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>At this point the version 2 application is operational but not accessible externally to the cluster.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="blue-green-deployment"><a class="anchor" href="#blue-green-deployment"></a>Blue / Green Deployment</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The benefit of creating the new version of the application alongside the old is that it is quick and easy to migrate users to a new version of the application. It also allows teams to validate that the pods are running correctly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Switching the route from v1 to v2 involves patching the route to change configuration. Before executing this operation open a new command window and execute the command below to send requests to the route every second. The responses received should all include the ip address of the pod and the version (v1) of the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>for i in {1..1000}; do curl $(oc get route simple-rest-app-route -o jsonpath='{"http://"}{.spec.host}') ; echo ""; sleep 1; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>A series of reports of ip address and version 1 of the application will then start to scroll up the screen. Leave this running.</p>
</div>
<div class="paragraph">
<p>Switch back to the original command window and execute the command below to patch the route to version 2 of the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc patch route/simple-rest-app-route -p '{"spec":{"to":{"name":"simple-rest-app-v2-0"}}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch back to the command window with the shell script running and you should see the responses have a new ip address and now report v2 of the application. This has completed a migration from the old version of the application to the new.</p>
</div>
<div class="paragraph">
<p>The details of the route patched by the above command are displayed by the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get route/simple-rest-app-route -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the above command is shown below, and the nested information from spec &#8594; to &#8594; name is easy to see.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: route.openshift.io/v1
kind: Route
metadata:
  annotations:
    openshift.io/host.generated: "true"
  creationTimestamp: 2019-12-04T17:16:37Z
  labels:
    app: simple-rest-app-v1-0
  name: simple-rest-app-route
  namespace: simple-rest-XX
  resourceVersion: "884652"
  selfLink: /apis/route.openshift.io/v1/namespaces/simple-rest/routes/simple-rest-app-route
  uid: d4910fef-16b9-11ea-a6c5-0a580a800048
spec:
  host: simple-rest-app-route-simple-rest.apps.cluster-telf-c8e6.telf-c8e6.example.opentlc.com
  port:
    targetPort: 8080-tcp
  subdomain: ""
  to:
    kind: Service
    name: simple-rest-app-v2-0
    weight: 100
  wildcardPolicy: None
status:
  ingress:
  - conditions:
    - lastTransitionTime: 2019-12-04T17:16:38Z
      status: "True"
      type: Admitted
    host: simple-rest-app-route-simple-rest.apps.cluster-telf-c8e6.telf-c8e6.example.opentlc.com
    routerCanonicalHostname: apps.cluster-telf-c8e6.telf-c8e6.example.opentlc.com
    routerName: default
    wildcardPolicy: None</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before moving to the A/B deployment strategy switch back to version v1 with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc patch route/simple-rest-app-route -p '{"spec":{"to":{"name":"simple-rest-app-v1-0"}}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Confirm this has worked in the command window executing the shell script.</p>
</div>
</div>
<div class="sect2">
<h3 id="ab-deployment"><a class="anchor" href="#ab-deployment"></a>A/B Deployment</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The benefit of an A/B deployment strategy is that it is possible to gradually migrate workload to the new version. This example presents a simple process of gradually migrating a higher and higher percentage of traffic to the new version, however more advanced options are available for migrating traffic based on headers or source ip address to name just two. Red Hat OpenShift Service Mesh is another topic that is worth investigation if advanced traffic routing operations are required.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Gradually migrating traffic from v1 to v2 involves patching the route to change configuration as shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/deployment-strategies-3.png" alt="Traffic routing">
</div>
</div>
<div class="paragraph">
<p>To migrate 30% of traffic to version 2 execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc set route-backends simple-rest-app-route simple-rest-app-v1-0=70 simple-rest-app-v2-0=30</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch back to the command window running the shell script and after a short wait you will see the occasional report from version 2.</p>
</div>
<div class="paragraph">
<p>To balance the workload between the two versions execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc set route-backends simple-rest-app-route simple-rest-app-v1-0=50 simple-rest-app-v2-0=50</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch back to the command window running the shell script and after a short wait you will see a more even distribution of calls between versions 1 and 2.</p>
</div>
<div class="paragraph">
<p>The details of the route patched by the above command are displayed by the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get route/simple-rest-app-route -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>A section of the output of the above command is included below, showing the split of traffic between versions 1 and 2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>spec:
  alternateBackends:
  - kind: Service
    name: simple-rest-app-v2-0
    weight: 50
  host: simple-rest-app-route-simple-rest.apps.cluster-telf-c8e6.telf-c8e6.example.opentlc.com
  port:
    targetPort: 8080-tcp
  subdomain: ""
  to:
    kind: Service
    name: simple-rest-app-v1-0
    weight: 50</code></pre>
</div>
</div>
<div class="paragraph">
<p>When satisfied that version 2 is working as required the following command will switch all traffic to that version.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc set route-backends simple-rest-app-route simple-rest-app-v1-0=0 simple-rest-app-v2-0=100</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="url-based-routing"><a class="anchor" href="#url-based-routing"></a>URL based routing</h3>
<div class="paragraph">
<p>Many organizations want to use a common URL for their web sites so that it is easy for users. This is often achieved by pointing a specific URL at an OpenShift cluster route within a global load balancer function, however this is not essential and it is possible to use routes to achieve the same result. Take as an example a holiday company called myholiday.com. The company wishes to sell package holidays, short breaks, cruises and adventure holidays and they create different applications for these purposes. By using a common host name in a series of route it is possible to ensure that traffic flows to the right location, based on the path of the url used. The diagram below shows the descried scenario and how the routes, services and applications work together</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/deployment-strategies-4.png" alt="URL based routing">
</div>
</div>
<div class="paragraph">
<p>In this example you will create an application that mirrors that shown above and you will use a single URL for access to the four different elements of the application.</p>
</div>
<div class="sect3">
<h4 id="creating-the-applications"><a class="anchor" href="#creating-the-applications"></a>Creating the applications</h4>
<div class="paragraph">
<p>This example uses a common code base to create the specific applications for the above four holiday types. To create the four applications in a single project use the steps below substituting your student number for 'X' so that you get a separate project to other users in the workshop.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-project myholidayX
oc new-app https://github.com/utherp0/workshop4.git --context-dir=attendee/myholiday \
--name=short-holiday -l app.kubernetes.io/part-of=holidays HOLIDAY_TYPE=short-break
oc new-app https://github.com/utherp0/workshop4.git --context-dir=attendee/myholiday \
--name=package-holiday -l app.kubernetes.io/part-of=holidays HOLIDAY_TYPE=package
oc new-app https://github.com/utherp0/workshop4.git --context-dir=attendee/myholiday \
--name=cruise-holiday -l app.kubernetes.io/part-of=holidays HOLIDAY_TYPE=cruise
oc new-app https://github.com/utherp0/workshop4.git --context-dir=attendee/myholiday \
--name=adventure-holiday -l app.kubernetes.io/part-of=holidays HOLIDAY_TYPE=adventure</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch to the web user interface and select the project that you have just created. Then select the topology view from the left hand side developer menu and watch the applications build and deploy. Progress of the build phase can also be tracked using the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get build</code></pre>
</div>
</div>
<div class="paragraph">
<p>When all of the builds are complete the applications will take a few seconds to deploy and then will be ready.</p>
</div>
<div class="paragraph">
<p>At this stage the applications have services but they do not have any routes exposing them outside the cluster. Ordinarily users would create a route for each application which would result in a different URL for each. In this activity a common URL is required for all four.</p>
</div>
<div class="paragraph">
<p>To identify the cluster specific element of the hostname to use for the route, create a temporary route using the command below. The second command is used to get the hostname for the route.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code> oc expose service/adventure-holiday
 oc get route adventure-holiday -o jsonpath='{.spec.host}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will result in a new route being created and the hostname will be displayed similar to :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>adventure-holiday-myholiday2.apps.cluster-c2d5.c2d5.example.opentlc.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>The element of the path that we need for the new common hostname is from the .apps part forward, and a new part will be created to replace 'adventure-holiday-myholiday2' based on the project name. A shell script is used to configure the four route creation yaml files which are downloaded from the workshop git repository. If you have not already done so clone the git repository using the command below and then switch directory and examine one of the yaml files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>git clone https://github.com/utherp0/workshop4.git
cd workshop4/attendee/myholiday
cat adventure-route.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The YAML file is shown below :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: route.openshift.io/v1
kind: Route
metadata:
  labels:
    app: adventure-holiday
  name: adventure-route
spec:
  host: URL
  path: "/adventure"
  to:
    kind: Service
    name: adventure-holiday
    weight: 100</code></pre>
</div>
</div>
<div class="paragraph">
<p>The host 'URL' will be replaced by the configure-routes.sh shell script. The path shows /adventure, and a similar path exists in the cruise, package and short-break files to point to their specific paths.</p>
</div>
<div class="paragraph">
<p>Execute the shell script 'configure-routes.sh' with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>./configure-routes.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now take another look at adventure-route.yaml, which will be similar to that which is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: route.openshift.io/v1
kind: Route
metadata:
  labels:
    app: adventure-holiday
  name: adventure-route
spec:
  host: myholiday2.apps.cluster-c2d5.c2d5.example.opentlc.com
  path: "/adventure"
  to:
    kind: Service
    name: adventure-holiday
    weight: 100</code></pre>
</div>
</div>
<div class="paragraph">
<p>The host path is now made up of the common element from the project name and the common cluster specific path.</p>
</div>
<div class="paragraph">
<p>Delete the temporary route used to generate the hostname with the command below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc delete route/adventure-holiday</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute the following commands to create the four routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f adventure-route.yaml
oc create -f cruise-route.yaml
oc create -f package-route.yaml
oc create -f short-break-route.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examine the new routes using the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get routes</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example of the important information from the above command is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME                  HOST/PORT                                               PATH           SERVICES
adventure-route       myholiday2.apps.cluster-c2d5.c2d5.example.opentlc.com   /adventure     adventure-holiday
cruise-route          myholiday2.apps.cluster-c2d5.c2d5.example.opentlc.com   /cruise        cruise-holiday
package-route         myholiday2.apps.cluster-c2d5.c2d5.example.opentlc.com   /package       package-holiday
short-holiday-route   myholiday2.apps.cluster-c2d5.c2d5.example.opentlc.com   /short-break   short-holiday</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test the routes (copy and paste from your result of the 'oc get routes' command - do not copy the commands below &#8230;&#8203;. ) by accessing the four different holiday types from the common url with the curl commands below. The text responses will show that the correct application is responding to each request.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl &lt;common-url&gt;/adventure
curl &lt;common-url&gt;/cruise
curl &lt;common-url&gt;/package
curl &lt;common-url&gt;/short-break</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cleaning-up"><a class="anchor" href="#cleaning-up"></a>Cleaning up</h4>
<div class="paragraph">
<p>From the OpenShift browser window click on 'Advanced' and then 'Projects' on the left hand side menu.</p>
</div>
<div class="paragraph">
<p>In the triple dot menu next to your own project (simple-rest-X) select ‘Delete Project’
Type ‘simple-rest-X’ (where X is your user number) such that the Delete button turns red and is active.
Press Delete to remove the project.</p>
</div>
<div class="paragraph">
<p>Repeat the above process for the myholidayX project too.
== Understanding Deployments and Configuration [INTRODUCTION]</p>
</div>
<div class="paragraph">
<p>Author: Ian Lawson (feedback to <a href="mailto:ian.lawson@redhat.com">ian.lawson@redhat.com</a>)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="introduction-4"><a class="anchor" href="#introduction-4"></a>Introduction</h3>
<div class="paragraph">
<p>This lab will introduce the attendee to concepts of deployments and configuration injection using OpenShift Container Platform.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The attendee will be using a browser for interacting with both the OpenShift Container Platform UI and the provided terminal (for command line exercises). It is suggested the attendee uses Chrome or Firefox.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This lab follows directly on from the Application Basics one so it is assumed the attendee is logged on to the system and has the applications pre-created. If you are starting at this lab please repeat the commands from the Application Basics lab. You should start this lab with two applications running in the project 'sandbox*X*' (where X is your user number), nodenews and ocpnode
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="introducing-deployment-configurations"><a class="anchor" href="#introducing-deployment-configurations"></a>Introducing Deployment Configurations</h3>
<div class="paragraph">
<p>Ensure you are on the Administrator View (top level, select 'Administrator')
Select 'Workloads/Deployment Configs'</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/deployment-1.png" alt="Deployment Configs">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Observe the information provided on the Deployment Configs screen. DC indicates the Deployment Config by name, NS is the project/namespace, Labels are the OpenShift labels applied to the DC for collating and visualisation, status indicates the active Pod count for the Deployment and pod selector indicates the labels used for the Pods attributed to the Deployment Config.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on the 'nodenews' deployment-config</p>
</div>
<div class="paragraph">
<p>Next to the Pod icon, with the count in it which should be set to two, click on the up arrow twice</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/deployment-2.png" alt="Scaling the Deployment">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We have told the deployment config to run four replicas. The system now updated the replication controller, whose job is to make sure that x replicas are running healthily, and once the replication controller is updated the system will ensure that number of replicas is running
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on ‘YAML’</p>
</div>
<div class="paragraph">
<p>In the YAML find an entry for replicas. It should say 4. Set it to 2, then save.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/deployment-3.png" alt="Editing the DC YAML">
</div>
</div>
<div class="paragraph">
<p>Click on ‘Deployment Configs’ near the top of the panel.</p>
</div>
<div class="paragraph">
<p>Select the nodenews deployment config by clicking on the nodenews DC link</p>
</div>
<div class="paragraph">
<p>Ensure the Pod count is now two</p>
</div>
</div>
<div class="sect2">
<h3 id="dependency-injection-using-config-maps"><a class="anchor" href="#dependency-injection-using-config-maps"></a>Dependency Injection using Config Maps</h3>
<div class="paragraph">
<p>Click on 'Workloads/Config Maps'</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Config Maps allow you to create groups of name/value pairs in objects that can be expressed into the Applications via the Deployment Configs and can change the file system, environment and behaviour of the Application without having to change the 'image' from whence the Application was created. This is extremely useful for dependency injection without having to rebuild the Application image
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on ‘Create Config Map’</p>
</div>
<div class="paragraph">
<p>In the editor change the name: from example to ‘nodenewsconfig’</p>
</div>
<div class="paragraph">
<p>Delete all of the lines below <strong>data:</strong></p>
</div>
<div class="paragraph">
<p>Add “  env1: test”</p>
</div>
<div class="paragraph">
<p>Add “  env2: test”</p>
</div>
<div class="paragraph">
<p>Make sure there is a space between the ':' and the data itself, otherwise it is invalid YAML and the editor will not allow you to save it.</p>
</div>
<div class="paragraph">
<p>The YAML should look similar to the screenshot below, with your project name rather than CHANGETHIS.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/deployment-4.png" alt="Example Config Map YAML">
</div>
</div>
<div class="paragraph">
<p>Press 'Create'</p>
</div>
<div class="paragraph">
<p>Go back to the command line tab</p>
</div>
<div class="paragraph">
<p>Type ‘oc get configmaps’</p>
</div>
<div class="paragraph">
<p>Type ‘oc describe configmap nodenewsconfig’</p>
</div>
<div class="paragraph">
<p>Go back to UI, select 'Workloads/Deployment Configs'</p>
</div>
<div class="paragraph">
<p>Click on the 'nodenews' dc</p>
</div>
<div class="paragraph">
<p>Click on 'Environment'</p>
</div>
<div class="paragraph">
<p>In ‘All Values from existing config maps’ select nodenewsconfig from the pulldown on the left and add nodenewsconfig as the prefix in the righthand textbox (labelled PREFIX (OPTIONAL) )</p>
</div>
<div class="paragraph">
<p>Click 'Save'</p>
</div>
<div class="paragraph">
<p>Click on 'Workloads/Pods' - if you are quick enough you will see the nodenews Pods being redeployed</p>
</div>
<div class="paragraph">
<p><strong>By default when you create a Deployment Config in OpenShift, as part of an Application or as a standalone object via YAML, the Deployment Config will have two distinct triggers for automation. These make the Deployment redeploy when a: the image that the Deployment Config is based on changes in the registry or b: the defined configuration of the Deployment changes via a change to the DC object itself</strong></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
These are default behaviours but can be overridden. They are designed to make sure that the current deployment exactly matches the Images and the definition of the deployment by default.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on one of the Pods for 'nodenews'</p>
</div>
<div class="paragraph">
<p>In the Pod Details page click on 'Terminal'</p>
</div>
<div class="paragraph">
<p>In the terminal type ‘env | grep nodenewsconfig’</p>
</div>
<div class="paragraph">
<p><strong>Note that the env variables from the config map have been expressed within the Pod as env variables (with the nodenewsconfig prefixed)</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/deployment-5.png" alt="Injected config map environment variables">
</div>
</div>
<div class="paragraph">
<p>Go back to the Terminal tab you created in the pre-requisites. We are going to use some material pre-loaded into the terminal image. Type the following commands in the Terminal tab.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/attendee
cat testfile.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This file is the one to be used. If it, or any of the directories, don&#8217;t exist, please follow the pre-requisite instructions and recreate the Terminal application.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All objects in Kubernetes/Openshift can be expressed as yaml and this is a basic configmap for a file. What is very nice about the API and it&#8217;s object oriented nature is that you can export any object that you have the RBAC rights to view and import them directly back into OpenShift, which is what we will do now with the following commands in the terminal
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f testfile.yaml
oc get configmaps</code></pre>
</div>
</div>
<div class="paragraph">
<p>Go back to the UI, select 'Workloads/Deployment Configs'</p>
</div>
<div class="paragraph">
<p>Select 'nodenews' dc</p>
</div>
<div class="paragraph">
<p>Click on 'YAML'</p>
</div>
<div class="paragraph">
<p>In order to add the config-map as a volume we need to change the container specification within the deployment config.</p>
</div>
<div class="paragraph">
<p>Find the setting for ‘imagePullPolicy’. Put the cursor to the end of the line. Hit return. Underneath enter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        volumeMounts:
          - name: workshop-testfile
            mountPath: /workshop/config</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure the indentation is the same as for the ‘imagePullPolicy’.</p>
</div>
<div class="paragraph">
<p>Now in the ‘spec:’ portion we need to add our config-map as a volume.</p>
</div>
<div class="paragraph">
<p>Find ‘restartPolicy’. Put the cursor to the end of the line and press return. Underneath enter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>     volumes:
       - name: workshop-testfile
         configMap:
           name: testfile
           defaultMode: 420</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the deployment config.</p>
</div>
<div class="paragraph">
<p>Click on 'Workloads/Pods'. Watch the new versions of the nodenews application deploy.</p>
</div>
<div class="paragraph">
<p>When they finish deploying click on one of the nodenews Pods. Click on 'Terminal'.</p>
</div>
<div class="paragraph">
<p>In the terminal type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workshop
ls
cd config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note that we have a new file called ‘app.conf’ in this directory. This file is NOT part of the image that generated the container.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the terminal type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cat app.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>This is the value from the configmap object expressed as a file into the running container.</strong></p>
</div>
<div class="paragraph">
<p>In the terminal type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi app.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Press ‘i’ to insert, then type anything. Then press ESC. Then type ‘:wq’</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You will not be able to save it. The file expressed into the Container from the configmap is ALWAYS readonly which ensures
any information provided via the config map is controlled and immutable.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Type ‘:q!’ to quit out of the editor</p>
</div>
</div>
<div class="sect2">
<h3 id="dependency-injection-of-sensitive-information-using-secrets"><a class="anchor" href="#dependency-injection-of-sensitive-information-using-secrets"></a>Dependency Injection of sensitive information using Secrets</h3>
<div class="paragraph">
<p><strong>The config map to be written as a file is actually written to the Container Hosts as a file, and then expressed into the running Container as a symbolic link. This is good but can be seen as somewhat insecure because the file is stored 'as-is' on the Container Hosts, where the Containers are executed</strong></p>
</div>
<div class="paragraph">
<p><strong>For secure information, such as passwords, connection strings and the like, OpenShift has the concept of 'Secrets'. These act like config maps 'but' importantly the contents of the secrets are encrypted at creation, encrypted at storage when written to the Container Hosts and then unencrypted only when expressed into the Container, meaning only the running Container can see the value of the secret.</strong></p>
</div>
<div class="paragraph">
<p>In the UI select 'Workloads/Secrets'</p>
</div>
<div class="paragraph">
<p>Click on 'Create'</p>
</div>
<div class="paragraph">
<p>Choose ‘Key/Value Secret'</p>
</div>
<div class="paragraph">
<p>For ‘Secret Name’ give ‘nodenewssecret’</p>
</div>
<div class="paragraph">
<p>Set ‘Key’ to ‘password’</p>
</div>
<div class="paragraph">
<p>Set ‘Value’ textbox to ‘mypassword’</p>
</div>
<div class="paragraph">
<p>Click ‘Create’</p>
</div>
<div class="paragraph">
<p>When created click on the ‘YAML’ box in the Secrets/Secret Details overview</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note that the type is ‘Opaque’ and the data is encrypted
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on ‘Add Secret To Workload’</p>
</div>
<div class="paragraph">
<p>In the ‘Select a workload’ pulldown select the nodenews DC</p>
</div>
<div class="paragraph">
<p>Ensure the ‘Add Secret As’ is set to Environment Variables</p>
</div>
<div class="paragraph">
<p>Add the Prefix ‘secret’</p>
</div>
<div class="paragraph">
<p>Click ‘Save’</p>
</div>
<div class="paragraph">
<p>Watch the Pods update on the subsequent ‘DC Nodenews’ overview</p>
</div>
<div class="paragraph">
<p>When they have completed click on ‘Pods’</p>
</div>
<div class="paragraph">
<p>Choose one of the nodenews running pods, click on it, choose Terminal</p>
</div>
<div class="paragraph">
<p>In the terminal type ‘env | grep secret’</p>
</div>
</div>
<div class="sect2">
<h3 id="understanding-the-deployment-strategies"><a class="anchor" href="#understanding-the-deployment-strategies"></a>Understanding the Deployment Strategies</h3>
<div class="paragraph">
<p>Click on 'Workloads/Deployment Configs'</p>
</div>
<div class="paragraph">
<p>Click on the DC for 'nodenews'</p>
</div>
<div class="paragraph">
<p>Scale the Application up to four copies using the up arrow next to the Pod count indicator</p>
</div>
<div class="paragraph">
<p>Once the count has gone to 4 and all the Pods are indicated as healthy (the colour of the Pod ring is blue for all Pods) select Action/Start Rollout.</p>
</div>
<div class="paragraph">
<p>The DC panel will now render the results of the deployment.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Deployments can have one of two strategies. This example uses the 'Rolling' strategy which is designed for zero downtime deployments. It works but spinning up a single copy of the new Pod, and when that Pod reports as being healthy only then is one of the old Pods removed. This ensures that at all times the required number of replicas are running healthy with no downtime for the Application itself.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on 'Actions/Edit Deployment Config'</p>
</div>
<div class="paragraph">
<p>Scroll the editor down to the ‘spec:’ tag as shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>spec:
 strategy:
   type: Rolling
   rollingParams:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Change the type: tag of the strategy to Recreate as shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>spec:
 strategy:
   type: Recreate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Click on 'Save'</p>
</div>
<div class="paragraph">
<p>Click on 'Workloads/Deployment Configs', select nodenews dc</p>
</div>
<div class="paragraph">
<p>Click on ‘Action/Start Rollout’</p>
</div>
<div class="paragraph">
<p>Watch the colour of the Pod rings as the system carries out the deployment</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In the case of a Recreate strategy the system ensures that NO copies of the old deployment are running simultaneously with the new ones. It deletes all the running Pods, regardless of the required number of replicas, and when all Pods report as being fully deleted it will start spinning up the new copies. This is for a scenario when you must NOT have any users interacting with the old Application once the new one is deployed, such as a security flaw in the old Application
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="cleaning-up-2"><a class="anchor" href="#cleaning-up-2"></a>Cleaning up</h4>
<div class="paragraph">
<p>From the OpenShift browser window, click on 'Home' and then 'Projects' on the left hand side menu.</p>
</div>
<div class="paragraph">
<p>In the triple dot menu next to your own project (sandboxX) select ‘Delete Project’
Type ‘sandboxX’ (where X is your user number) such that the Delete button turns red and is active.</p>
</div>
<div class="paragraph">
<p>Press Delete to remove the project.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="healthprobes"><a class="anchor" href="#healthprobes"></a>Pod Health Probes [ESSENTIALS]</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Mark Roberts (feedback to <a href="mailto:mroberts@redhat.com">mroberts@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction-5"><a class="anchor" href="#introduction-5"></a>Introduction</h3>
<div class="paragraph">
<p>Liveness and Readiness probes are Kubernetes capabilities that enable teams to make their containerized applications more reliable and robust. However, if used inappropriately they can result in none of the intended benefits, and can actually make a microservice based application unstable.</p>
</div>
<div class="paragraph">
<p>The purpose of each probe is quite simple and is described well in the OpenShift documentation here. The use of each probe is best understood by examining the action that will take place if the probe is activated.</p>
</div>
<div class="paragraph">
<p><strong>Liveness</strong> : Under what circumstances is it appropriate to restart the pod?</p>
</div>
<div class="paragraph">
<p><strong>Readiness</strong> : under what circumstances should we take the pod out of the list of service endpoints so that it no longer responds to requests?</p>
</div>
<div class="paragraph">
<p>Coupled with the action of the probe is the type of test that can be performed within the pod :</p>
</div>
<div class="paragraph">
<p><strong>Http GET request</strong> : For success, a request to a specific http endpoint must result in a response between 200 and 399.</p>
</div>
<div class="paragraph">
<p><strong>Execute a command</strong> : For success, the execution of a command within the container must result in a return code of 0.</p>
</div>
<div class="paragraph">
<p><strong>TCP socket check</strong> : For success, a specific TCP socket must be successfully opened on the container.</p>
</div>
</div>
<div class="sect2">
<h3 id="creating-the-project-and-application"><a class="anchor" href="#creating-the-project-and-application"></a>Creating the project and application</h3>
<div class="paragraph">
<p>Log on to cluster as userx, password openshift</p>
</div>
<div class="paragraph">
<p>Ensure you are on the Administrator View (top level, select Administrator)</p>
</div>
<div class="paragraph">
<p><strong>The Administrator view provides you with an extended functionality interface that allows you to deep dive into the objects available to your user. The Developer view is an opinionated interface designed to ease the use of the system for developers. This workshop will have you swapping between the contexts for different tasks.</strong></p>
</div>
<div class="paragraph">
<p>Click on 'Create Project'</p>
</div>
<div class="paragraph">
<p>Name - ‘probesX’ where X is your assigned user number</p>
</div>
<div class="paragraph">
<p>Display Name - 'Probes'</p>
</div>
<div class="paragraph">
<p>Description - 'Liveness and readiness probes'</p>
</div>
<div class="paragraph">
<p>as shown in the image below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/healthprobes-1.png" alt="Project creation">
</div>
</div>
<div class="paragraph">
<p><strong>By default when you create a Project within OpenShift your user is given administration rights. This allows the user to create any objects that they have rights to create and to change the security and access settings for the project itself, i.e. add users as Administrators, Edit Access, Read access or disable other user&#8217;s abilities to even see the project and the objects within.</strong></p>
</div>
<div class="paragraph">
<p>In the top left of the UI, where the label indicates the view mode, change the mode from Administrator to Developer and select the Topology view.</p>
</div>
<div class="paragraph">
<p>Select ‘From Catalog’</p>
</div>
<div class="paragraph">
<p>Enter ‘node’ in the search box</p>
</div>
<div class="paragraph">
<p><strong>The various catalogue items present different configurations of applications that can be created. For example the node selections include a simple node.js application or node.js with a database platform that is pre-integrated and ready to use within the application. For this workshop you will use a simple node.js application.</strong></p>
</div>
<div class="paragraph">
<p>Select ‘Node.js’</p>
</div>
<div class="paragraph">
<p><strong>A wizard page will then pop up on the right hand side with details of exactly what will be created through the process.</strong></p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Source-2-Image</div>
<div class="paragraph">
<p>One of the most exciting features of OpenShift from a developer&#8217;s perspective is the concept of S2I, or <strong>Source-2-Image</strong> which provides a standardized way of taking a base image, containing, for example, the framework for running a node.js application,
a source code repository, containing the code of the application that matches the framework provided in the base image, and constructing and delivering a composite Application image to the Registry. Simply put this enables a developer to create source code for an application and OpenShift will convert that to a running application within a container with minimal effort. The process that you will use below is the Source-2-Image capability.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Click on ‘Create Application’</p>
</div>
<div class="paragraph">
<p><strong>The wizard process has a number of options that the user may elect to use. These include:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Selecting a specific version of Node to use</p>
</li>
<li>
<p>Selecting a GIT repository and choosing to use code from a specific directory within the repository.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Select the default offering for the Builder Image Version</p>
</div>
<div class="paragraph">
<p>For the GIT repository use : <a href="https://github.com/marrober/simpleRest.git" target="_blank" rel="noopener">https://github.com/marrober/simpleRest.git</a></p>
</div>
<div class="paragraph">
<p>In a separate browser tab go to <a href="https://github.com/marrober/simpleRest.git" target="_blank" rel="noopener">https://github.com/marrober/simpleRest.git</a></p>
</div>
<div class="paragraph">
<p><strong>You can see that the GIT repository at this location only has a small number of files specific to the application. There is no content specific to how the application should be built or deployed into a container.</strong></p>
</div>
<div class="paragraph">
<p>Close the github tab</p>
</div>
<div class="paragraph">
<p>Back at the OCP4.2 user interface complete the following information in the section titled 'General'.</p>
</div>
<div class="paragraph">
<p>For the Application name enter 'rest-application'.</p>
</div>
<div class="paragraph">
<p>For the Name field enter 'node-app-rest'</p>
</div>
<div class="paragraph">
<p><strong>The application name field is used to group together multiple items under a single grouping within the topology view. The name field is used to identify the specific containerised application.</strong></p>
</div>
<div class="paragraph">
<p>In the Resources section ensure that you select 'Deployment Config'</p>
</div>
<div class="paragraph">
<p>In the Advanced Options section ensure the ‘Create a route to the application’ checkbox is checked.</p>
</div>
<div class="paragraph">
<p>Click Create</p>
</div>
<div class="paragraph">
<p><strong>The user interface will then change to display the Topology view. This is a pictorial representation of the various items (applications, databases etc.) that have been created from the catalogue and added to an application grouping.</strong></p>
</div>
<div class="paragraph">
<p><strong>Multiple application groupings can exist within a single project.</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="viewing-the-running-application"><a class="anchor" href="#viewing-the-running-application"></a>Viewing the running application</h3>
<div class="paragraph">
<p>Click on the Icon marked ‘Node’</p>
</div>
<div class="paragraph">
<p><strong>A side panel will appear with information on the Deployment Configuration that has just been created. The overview tab shows summary information and allows the user to scale the number of pods up and down. The resources tab shows information on the building process, the pods and the services and route to reach the application (if these have been created).</strong></p>
</div>
<div class="paragraph">
<p>Wait for the Build to finish, the Pod to change from Container Creating to Running.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Pod Colour Scheme</div>
<div class="paragraph">
<p>The colour scheme of the pods is important and conveys information about the pod health and status. The following colours are used :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Running - Dark blue</p>
</li>
<li>
<p>Not Ready - Mid blue</p>
</li>
<li>
<p>Warning - Orange</p>
</li>
<li>
<p>Failed - Red</p>
</li>
<li>
<p>Pending - light blue</p>
</li>
<li>
<p>Succeeded - Green</p>
</li>
<li>
<p>Terminating - Black</p>
</li>
<li>
<p>Unknown - Purple</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>When the build has completed the right hand side panel will shown something similar to the image below. Note that the route will be different to that which is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/healthprobes-2.png" alt="Deployment configuration resource information">
</div>
</div>
<div class="paragraph">
<p>Click on the Tick at the bottom left of the Pod. Note that this display can also be shown by clicking on the ‘View Logs’ section on the right hand side panel.</p>
</div>
<div class="paragraph">
<p><strong>The build log will show information on the execution of the source-2-image process.</strong></p>
</div>
<div class="paragraph">
<p>Click on the arrow on the top right corner of the Pod, or click on the route URL shown in the right hand side resource details window. The application window will launch in a new browser window and should display text as shown below:</p>
</div>
<div class="paragraph">
<p><strong>Hello - this is a simple REST interface v1.0</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="liveness-probe"><a class="anchor" href="#liveness-probe"></a>Liveness Probe</h3>
<div class="paragraph">
<p><strong>A number of probes will be created to show the different behaviors. The first probe will be a liveness probe that will result in the restart of the pod.</strong></p>
</div>
<div class="paragraph">
<p><strong>Since this work will be done using the oc command line you need to switch the current oc command line to work with the new project using the command:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc project probesX</code></pre>
</div>
</div>
<div class="paragraph">
<p>(Where X is the number that you used when you created the project)</p>
</div>
<div class="paragraph">
<p><strong>To create the probe use the OC command line interface to execute the following command.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc set probe dc/node-app-rest --liveness --initial-delay-seconds=30 --failure-threshold=1 --period-seconds=10 --get-url=http://:8080/health</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>The above probe will create a new liveness probe with the characteristics:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Become active after 30 seconds</p>
</li>
<li>
<p>Initiated a reboot after 1 instance of a failure to respond</p>
</li>
<li>
<p>Probe the application every 10 seconds <em>Note that ordinarily a gap of 10 seconds between probes would be considered very long, but we use this time delay within the workshop to allow time for observing the behavior of the probe.</em></p>
</li>
<li>
<p>Use the URL /health on the application at port 8080. Note that there is no need to specify a URL for the application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>The command line response should be as shown below.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>deploymentconfig.apps.openshift.io/node-app-rest probes updated</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Review the liveness probe information by executing the command:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc describe dc/node-app-rest</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>The output of this command will include the following section that highlights the new liveness probe</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Pod Template:
  Labels:	app=node-app-rest
		    deploymentconfig=node-app-rest
  Containers:
   node-app-rest:
    Image:		image-registry.openshift-image-registry.svc:5000/probes2/node-app-rest@sha256:bf377...241
    Port:		    8080/TCP
    Host Port:		0/TCP
    Liveness:		http-get http://:8080/health delay=30s timeout=1s period=10s #success=1 #failure=1
    Environment:	&lt;none&gt;
    Mounts:		    &lt;none&gt;
  Volumes:		    &lt;none&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Alternatively to view the probe in a different format use the command below:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get dc/node-app-rest -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Part of the output will show:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>livenessProbe:
    failureThreshold: 1
    httpGet:
        path: /health
        port: 8080
        scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    successThreshold: 1
    timeoutSeconds: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>To view the above information graphically then use the following steps:</strong></p>
</div>
<div class="paragraph">
<p>Select the Topology view of the application.</p>
</div>
<div class="paragraph">
<p>Click on the pod in the centre of the screen to display the information panel on the right hand side.
From the action menu on the right hand side click <strong>Edit Deployment Configuration</strong> as shown in the image below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/healthprobes-3.png" alt="View of the health probe in the Deployment Configuration">
</div>
</div>
<div class="paragraph">
<p><strong>On the Deployment Configuration page that is displayed ensure that the YAML tab is selected and scroll down to aroundline 68 to see the YAML definition for the liveness probe. It is also possible to edit the parameters of the probe from this screen if necessary.</strong></p>
</div>
<div class="paragraph">
<p><strong>In order to execute the probe it is necessary to simulate a pod failure that will stop the application from responding to the health check. A specific REST interface on the application has been created for this purpose called /ignore.</strong></p>
</div>
<div class="sect3">
<h4 id="activation-of-the-liveness-prove"><a class="anchor" href="#activation-of-the-liveness-prove"></a>Activation of the Liveness Prove</h4>
<div class="paragraph">
<p><strong>To view the activity of the probe it is necessary to open two windows.</strong></p>
</div>
<div class="paragraph">
<p>Select the Topology view of the application.</p>
</div>
<div class="paragraph">
<p>Click on the arrow on the top right hand corner of the node icon to open the application URL in a new browser tab.</p>
</div>
<div class="paragraph">
<p>Back on the OpenShift browser tab, Click on the pod to open the details window on the right hand side and then click on the pod link on the resources tab. This will display a multi-tab window with details of the pod, select the events tab.</p>
</div>
<div class="paragraph">
<p>Switch to the application tab and put /ip on the end of the url and hit return. This will display the ip address of the pod.</p>
</div>
<div class="paragraph">
<p>Change the url to have /health on the end and hit return. This will display the amount of time that the pod has been running.</p>
</div>
<div class="paragraph">
<p>Change the url to have /ignore on the end and hit return. Quickly move to the browser tab showing the pod events and watch for the probe event.</p>
</div>
<div class="paragraph">
<p>The pod will restart after 1 failed probe event which takes up to 10 seconds depending on where the schedule is between the probe cycles. The events for the pod on the details screen will be similar to that shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/healthprobes-4.png" alt="Pod events showing activation of the liveness probe">
</div>
</div>
<div class="paragraph">
<p><strong>The events after the firing of the liveness probe are the re-pulling and starting of the container image in a new pod.</strong></p>
</div>
<div class="paragraph">
<p>Switch to the application tab and put /health on the end of the url and hit return. This will display the amount of time that the new pod has been running, which will understandably be a small number.</p>
</div>
<div class="paragraph">
<p><strong>In order to experiment with the readiness probe it is necessary to switch off the liveness probe. This can either be done by changing the deployment configuration YAML definition using the web interface or by executing the following command line:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc set probe dc/node-app-rest --liveness --remove</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="readiness-probe"><a class="anchor" href="#readiness-probe"></a>Readiness Probe</h3>
<div class="paragraph">
<p><strong>To create the probe use the OC command line interface to execute the following command.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc set probe dc/node-app-rest --readiness --initial-delay-seconds=30 --failure-threshold=3 --success-threshold=1  --period-seconds=5 --get-url=http://:8080/health</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>The above command will create a new readiness probe with the characteristics:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Become active after 30 seconds</p>
</li>
<li>
<p>Remove the pod from the service endpoint after 3 instances of a failure to respond</p>
</li>
<li>
<p>Cancel the removal of the pod and add it back to the service endpoint after 1 successful response</p>
</li>
<li>
<p>Probe the application every 5 seconds</p>
</li>
<li>
<p>Use the URL /health on the application at port 8080. Note that there is no need to specify a URL for the application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>The command line response should be as shown below</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>deploymentconfig.apps.openshift.io/node-app-rest probes updated</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Review the probe created using the commands above:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc describe dc/node-app-rest</code></pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get dc/node-app-rest -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>View the state of the pod within the endpoints using the command below:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get ep/node-app-rest -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>The output of the above command will list the details of the service endpoint which will include information on the pod to which the health probe is attached as shown below.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: v1
kind: Endpoints
metadata:
  annotations:
    endpoints.kubernetes.io/last-change-trigger-time: 2019-11-26T16:04:50Z
  creationTimestamp: 2019-11-26T09:37:12Z
  labels:
    app: node-app-rest
    app.kubernetes.io/component: node-app-rest
    app.kubernetes.io/instance: node-app-rest
    app.kubernetes.io/name: nodejs
    app.kubernetes.io/part-of: master-rest
    app.openshift.io/runtime: nodejs
    app.openshift.io/runtime-version: "10"
  name: node-app-rest
  namespace: probes1
  resourceVersion: "1172051"
  selfLink: /api/v1/namespaces/probes1/endpoints/node-app-rest
  uid: 534139aa-1030-11ea-af1c-024039909e8a
subsets:
- addresses:
  - ip: 10.128.2.145
    nodeName: ip-10-0-136-74.eu-central-1.compute.internal
    targetRef:
      kind: Pod
      name: node-app-rest-5-hwj89
      namespace: probes1
      resourceVersion: "1172049"
      uid: ad6cc0e5-1043-11ea-af1c-024039909e8a
  ports:
  - name: 8080-tcp
    port: 8080
    protocol: TCP</code></pre>
</div>
</div>
<div class="paragraph">
<p>The lines of interest above are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>subsets:
- addresses:
  - ip: 10.128.2.145</code></pre>
</div>
</div>
<div class="paragraph">
<p>This shows that the address is currently part of the endpoint (it will participate in servicing requests) prior to the readiness probe activation.</p>
</div>
<div class="sect3">
<h4 id="activation-of-the-readiness-probe"><a class="anchor" href="#activation-of-the-readiness-probe"></a>Activation of the Readiness Probe</h4>
<div class="paragraph">
<p>Select the Topology view of the application.</p>
</div>
<div class="paragraph">
<p>Click on the arrow on the top right hand corner of the node icon to open the application URL in a new browser tab (unless you already have one open).</p>
</div>
<div class="paragraph">
<p>On the OpenShift browser tab, click on the pod to open the details window on the right hand side and then click on the pod link on the resources tab. This will display a multi-tab window with details of the pod, select the events tab.</p>
</div>
<div class="paragraph">
<p>Switch to the application tab and put /ip on the end of the url and hit return. This will display the ip address of the pod.</p>
</div>
<div class="paragraph">
<p>Change the url to have /health on the end and hit return. This will display the amount of time that the pod has been running.</p>
</div>
<div class="paragraph">
<p>Change the url to have /ignore on the end and hit return. Quickly move to the browser tab showing the pod events and watch for the probe event.</p>
</div>
<div class="paragraph">
<p>The pod events will show a screen similar to that which is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/healthprobes-5.png" alt="Pod events showing activation of the readiness probe">
</div>
</div>
<div class="paragraph">
<p><strong>Note that you will see the count of the readiness 'events' incrementing every 5 seconds.</strong></p>
</div>
<div class="paragraph">
<p><strong>You will also see that the events continue counting up since readiness probes do not stop firing just because the pod has been removed from the endpoint list. It is important that they continue to probe since the conditions may change and it may be appropriate to add the pod back into the endpoint list.</strong></p>
</div>
<div class="paragraph">
<p>View the state of the pod within the endpoints using the command below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get ep/node-app-rest -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>The output of the above command will list the details of the service endpoint which will include information on the pod to which the health probe is attached as shown below.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>subsets:
- notReadyAddresses:
  - ip: 10.128.2.145</code></pre>
</div>
</div>
<div class="paragraph">
<p>The subset of the command output shown above indicates that the address is now listed as ‘not ready’ and is not currently part of the endpoint.</p>
</div>
<div class="paragraph">
<p><strong>Under production use conditions for the application may change and the pod may recover from the inability to respond to the readiness probe. If this happens then it will be added back to the endpoint list.</strong></p>
</div>
<div class="paragraph">
<p><strong>To simulate this the Node application has a REST endpoint at /restore. Since the pod is currently not receiving communications from outside the cluster the call to the restore endpoint is done from within the pod command window.</strong></p>
</div>
<div class="paragraph">
<p>Switch to the OpenShift browser window that was showing the pod events.</p>
</div>
<div class="paragraph">
<p><strong>Note that you will see a large number of pod readiness probe failures while you were reading the notes.</strong></p>
</div>
<div class="paragraph">
<p>In the OpenShift Console choose Administrator View, then Workloads/Pods. Click on the Pod that is active and in the Pod information page click on the Terminal option.</p>
</div>
<div class="paragraph">
<p>Within the Pod Terminal enter the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl -k localhost:8080/restore</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>You should see a response similar to that shown below (with a different IP address):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>"10.128.2.146 restore switch activated"sh-4.2$</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now go back to the Terminal tab where you enter 'oc' commands</p>
</div>
<div class="paragraph">
<p>View the state of the pod within the endpoints using the command below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get ep/node-app-rest -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>You should see that the line of interest, previously shown above, has changed back to that shown below:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>subsets:
- addresses:
  - ip: &lt;ip address of the pod&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>On the OpenShift browser page switch back to the events tab and you should see that the readiness probe failure count is no longer increasing.</strong></p>
</div>
<div class="paragraph">
<p>Finally, switch to the application browser page and change the URL to end in /health. You should see that the application has been running for some time (compared to the liveness probe that showed a restart had taken place) and it should be responding successfully to the health probe.</p>
</div>
</div>
<div class="sect3">
<h4 id="cleaning-up-3"><a class="anchor" href="#cleaning-up-3"></a>Cleaning up</h4>
<div class="paragraph">
<p>From the OpenShift browser window click on 'Advanced' and then 'Projects' on the left hand side menu.</p>
</div>
<div class="paragraph">
<p>In the triple dot menu next to your own project (ProbesX) select ‘Delete Project’
Type ‘ProbesX’ (where X is your user number) such that the Delete button turns red and is active.</p>
</div>
<div class="paragraph">
<p>Press Delete to remove the project.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="openshift-do-devtools"><a class="anchor" href="#openshift-do-devtools"></a>OpenShift DO [DEVTOOLS]</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Mark Roberts (feedback to <a href="mailto:mroberts@redhat.com">mroberts@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction-6"><a class="anchor" href="#introduction-6"></a>Introduction</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">An overview of odo</div>
<div class="paragraph">
<p>The OpenShift command line interface 'oc' is a general purpose interface with a vast set of commands for both development and administrative purposes. The odo command is a more developer centric command line interface for users who simply want to build, deploy and run applications on OpenShift. There is definitely a place for both tools within the kitbag of an OpenShift user, and for fast iterations of edit - run - edit - run the odo interface is perfect.</p>
</div>
<div class="paragraph">
<p>The approach described in the application basics chapter used a GIT repository as the source of the content to be built and deployed. This is a excellent approach when multiple users are working together in a complex application performing frequent integration of source code in GIT and validating their combined efforts as the project progresses. Avoiding such frequent integration activity will make the code of each developer diverge storing up integration headaches in the future.</p>
</div>
<div class="paragraph">
<p>The ability of the OpenShift 'Source-2-image' capability to identify the code within the GIT repository (from the options of Node.js, Java, Ruby, Perl, PHP, and Python), select a builder image, build the code and deliver a new container with the running application is a huge efficiency advantage for teams. However there are scenarios in which a single developer simply wants to get their code running as quickly as possible and which is where odo can be advantageous.</p>
</div>
<div class="paragraph">
<p>The principle of the odo command is that it can very quickly create a new project and use a 'GIT like' syntax to enable a developer to push the code into OpenShift. The receiving OpenShift cluster will then decide how to build the code, perform the build and deliver a running container. When the developer wants to make changes they simply push their code and the build and deploy operations are repeated. The first push process may take around a minute, but after that each iteration will take only a few seconds.</p>
</div>
<div class="paragraph">
<p>The diagram below shows how the odo command can fit into a development cycle. The outline diagram shows that the odo command is appropriate for single developers working with a degree of isolation, the team development involves multiple developers integrating their code through a GIT repository and the final phase involves the use of multiple clusters for the deployment of applications through to production.</p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/odo-1.png" alt="odo in the development cycle">
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>In more detail the diagram below shows how odo and oc / source-2-image work together to create a scaled development experience. In the single user phase the odo command is used to push the application code to a container in OpenShift. In the light blue box the source code is pushed to OpenShift in which the language specific builder image is used to create a new image containing the built code. This  image is started to create a running container. When the developer needs to share the code with the work of others GIT is used as a vehicle for integration and to remove any code conflicts.  This is the medium blue box in which the code is pushed to GIT and the OpenShift source-2-image capability is used to build a new running container. In the final phase shown in the darker blue box, the built container image can then be pushed to the Quay image repository to be stored securely ready for deployment to further environments such as pre-production and production.</p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/odo-2.png" alt="odo in the development cycle - detail">
</div>
</div>
</div>
<div class="sect2">
<h3 id="installing"><a class="anchor" href="#installing"></a>Installing</h3>
<div class="paragraph">
<p>The odo command line interface is built into the terminal that you create as a pre-requisite for this workshop so you don&#8217;t have to install anything right now. However, if you want to install the interface on your own workstation then it is available for download from here : <a href="https://github.com/openshift/odo" target="_blank" rel="noopener">https://github.com/openshift/odo</a>.</p>
</div>
<div class="paragraph">
<p><strong>If you haven&#8217;t already please follow the instructions in the pre-req chapter which explains the creation and setting up of the terminal application. For this chapter you will be using that application which has the odo command pre-installed for you</strong></p>
</div>
<div class="paragraph">
<p>Switch to the terminal application tab of the browser as described in the pre-req chapter</p>
</div>
<div class="paragraph">
<p><strong>To use the command simply type 'odo' and you will see help regarding the objects and to get help on a specific object use 'odo &lt;object&gt; --help'.</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="odo-command-set"><a class="anchor" href="#odo-command-set"></a>odo command set</h3>
<div class="paragraph">
<p><strong>The odo command has the following subcommands :</strong></p>
</div>
<div class="paragraph">
<p>Commands:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>app         Perform application operations (delete, describe, list)
catalog     Catalog related operations (describe, list, search)
component   Manage components (create, delete, describe, link, list, log, push, unlink, update, watch)
config      Change or view configuration (set, unset, view)
debug       Debug commands (port-forward)
preference  Modifies preference settings (set, unset, view)
project     Perform project operations (create, delete, get, list, set)
service     Perform service catalog operations (create, delete, list)
storage     Perform storage operations (create, delete, list)
url         Expose component to the outside world (create, delete, list)</pre>
</div>
</div>
<div class="paragraph">
<p>Utility Commands:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>login       Login to cluster
logout      Log out of the current OpenShift session
utils       Utilities for terminal commands and modifying odo configurations (terminal)
version     Print the client version information</pre>
</div>
</div>
<div class="paragraph">
<p>Component Shortcuts:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>create      Create a new component
delete      Delete component
describe    Describe component
link        Link component to a service or component
list        List all components in the current application
log         Retrieve the log for the given component
push        Push source code to a component
unlink      Unlink component to a service or component
update      Update the source code path of a component
watch       Watch for changes, update component on change</pre>
</div>
</div>
<div class="paragraph">
<p><strong>The most common are used within this workshop but feel free to experiment with any of the above commands.</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="logging-in"><a class="anchor" href="#logging-in"></a>Logging in</h3>
<div class="paragraph">
<p><strong>At this point if you are using the terminal as explained in the pre-req chapter you will already be logged into the system. This can be checked by typing the following:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc whoami
odo project list</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should result in your user name being displayed followed by the sandboxX project being shown by the result to the odo command. If you have deleted your sandbox project recreate it with the command below :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-project sandboxXX</code></pre>
</div>
</div>
<div class="paragraph">
<p>where xx is your user ID number.</p>
</div>
<div class="paragraph">
<p><strong>If you do need to login to odo outside of this workshop use the 'odo login' command with appropriate parameters</strong></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The odo command will evolve over time and it performs a check to see if you have the latest version each time it is used. If there is an update available you will be given a prompt to update from a given URL
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To see which version of odo you are using enter the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>odo version</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="examining-source-assets"><a class="anchor" href="#examining-source-assets"></a>Examining source assets</h4>
<div class="paragraph">
<p>The pipeline assets are located in a GIT repository that has been preinstalled in the terminal. Using your terminal window check the assets using the commands below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/attendee/simpleRest

ls -al</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see that the directory only has the source file simpleRest.js and the package file called package.json.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create-push-source-run-cycle"><a class="anchor" href="#create-push-source-run-cycle"></a>Create, push source &amp; run cycle</h3>
<div class="paragraph">
<p>Create a new project using the odo command replacing X with your user number below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>odo create nodejs node-app-rest-user-X</code></pre>
</div>
</div>
<div class="paragraph">
<p>TIP:The syntax of the above command is 'odo create &lt;component-type&gt; &lt;component-name&gt; --project &lt;project-for-the-component&gt;'</p>
</div>
<div class="paragraph">
<p>The result of running this command is simply the creation of a .odo directory containing a config.yaml file. The file contains the desired state for the application in OpenShift and is only committed to OpenShift and acted upon by OpenShift when the user issues the command 'odo push'. Examine the config.yaml file with the command below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>---
cat .odo/config.yaml
---</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a route for the application by using the command below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>odo url create node-app-rest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examine the contents of the .odo/config.yaml file again and you will see that new content has been added</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cat .odo/config.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now push the configuration to OpenShift by using the command below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>odo push</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output from the above command is shown below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/odo-3.png" alt="odo in the development cycle - detail">
</div>
</div>
<div class="paragraph">
<p>Wait for the response "Changes successfully pushed to component"</p>
</div>
<div class="paragraph">
<p>The application has started up and will be running at the URL indicated in the output above. Copy the URL from your command window and paste it into a new browser tab. You should see an output similar to that shown below.</p>
</div>
<div class="paragraph">
<p>Note - within the terminal window to copy text you should highlight the text, right click and select copy. To paste to the terminal window use ctrl-shift-v.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Hello - this is a simple REST interface v1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now make a small change to the comment in the source code of the simpleRest.js file to change the line shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>response.send('Hello - this is a simple REST interface' + versionIdentifier);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Change the response to the following</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>response.send('Hello - MODIFIED and pushed with ODO' + versionIdentifier);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now use odo to push the changed source to OpenShift</p>
</div>
<div class="paragraph">
<p>odo push</p>
</div>
<div class="paragraph">
<p>The code still needed to be pushed to the component, but the final stage of building the component is much faster. Refresh the browser window showing the application output and you will see your code change. The edit - push - test cycle is as simple as that</p>
</div>
</div>
<div class="sect2">
<h3 id="odo-watch"><a class="anchor" href="#odo-watch"></a>odo watch</h3>
<div class="paragraph">
<p>The odo process also has a 'watch' facility that allows you to force odo to constantly watch for source code changes and push them immediately. Open another instance of the terminal application by pointing a new tab in the browser to the route to the terminal application.</p>
</div>
<div class="paragraph">
<p>In the new terminal tab enter</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/attendee/simpleRest
odo watch</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command window should report : 'Waiting for something to change in &lt;current-working-directory&gt;'</p>
</div>
<div class="paragraph">
<p>Switch back to your other terminal window and make another change to the source code, similar to the change above. After saving the edit switch to the terminal window in which you typed 'odo watch' and observe that a new push of the code to OpenShift has taken place</p>
</div>
<div class="paragraph">
<p>The window with the watch command running will report:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>File &lt;path-to-source&gt;/simpleRest.js changed
Pushing files...
 ✓  Waiting for component to start [73ms]
 ✓  Syncing files to the component [11s]
 ✓  Building component [4s]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Refresh the browser window showing the application output and you will see your code change</p>
</div>
<div class="paragraph">
<p>odo is clearly a very fast way to go from code to running your application without having to install tools and frameworks on your laptop</p>
</div>
<div class="paragraph">
<p>Finally, let&#8217;s clean up the project by typing, replacing X with our user number.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>odo delete node-app-rest-user-X</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will delete the application from the project.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="openshift-pipelines-tekton-innovation"><a class="anchor" href="#openshift-pipelines-tekton-innovation"></a>OpenShift Pipelines - Tekton [INNOVATION]</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Mark Roberts (feedback to <a href="mailto:mroberts@redhat.com">mroberts@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction-7"><a class="anchor" href="#introduction-7"></a>Introduction</h3>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>For many years teams have created automation pipelines to build, unit test, analyse and deploy applications in a variety of tool-chains. Some such tool-chains (Jenkins for one) pre-date the popularization of containers and are now being questioned for their fit for the delivery of cloud native applications. While we are at pains not to criticize Jenkins (we are big users and fans) there is scope to look at alternative approaches for cloud native applications.*</p>
</div>
<div class="paragraph">
<p>OpenShift Pipelines are based on the Tekton open source project and they provide a Kubernetes style, resource based approach to the construction of pipelines. Tasks are defined as small units of operations (typically 10 to 15 lines of YAML) and such tasks are grouped together into taskruns or pipelines for execution.</p>
</div>
<div class="paragraph">
<p>A new command line exists for the execution of Tekton commands and a graphical user interface can be added to the cluster to provide a simple way to run tasks and to observe running or completed tasks.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The Tekton project can be found here : <a href="https://tekton.dev/" target="_blank" rel="noopener">https://tekton.dev/</a></p>
</div>
<div class="paragraph">
<p>Further documentation on the specifics of Tekton can be found on the github site here : <a href="https://github.com/tektoncd/pipeline" target="_blank" rel="noopener">https://github.com/tektoncd/pipeline</a></p>
</div>
</div>
<div class="sect2">
<h3 id="tasks"><a class="anchor" href="#tasks"></a>Tasks</h3>
<div class="sect3">
<h4 id="download-pipeline-assets"><a class="anchor" href="#download-pipeline-assets"></a>Download pipeline assets</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
As part of the pre-requisites you should have cloned the required git repo and created the base project for all the chapters - if you haven&#8217;t please go back to the pre-requisites and follow the instructions
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Check the required assets for the workshop are available in your terminal image using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/attendee/tekton/
ls -al</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should now see a list of yaml files that are used during the remainder of this chapter.</p>
</div>
</div>
<div class="sect3">
<h4 id="simple-task-creation-and-execution"><a class="anchor" href="#simple-task-creation-and-execution"></a>Simple task creation and execution</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In the simplest format a task can be executed by a taskrun object. The diagram below shows a simple taskrun calling a single task
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-1.png" alt="Simple pipeline with a task and taskrun">
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Tekton command line</div>
<div class="paragraph">
<p>A new command line utility is used to manage the Tekton command line. The commands cover the various different pipeline objects such as task, taskrun, pipeline, pipelinerun,  resources, cluster tasks and conditions.</p>
</div>
<div class="paragraph">
<p>The Tekton command line interface is built into the terminal that you create as a pre-requisite for this workshop so you don&#8217;t have to install anything right now. However, if you want to install the interface on your own workstation then it is available for download from here : <a href="https://github.com/tektoncd/cli" target="_blank" rel="noopener">https://github.com/tektoncd/cli</a></p>
</div>
<div class="paragraph">
<p>To use the command simply type 'tkn' and you will see help regarding the objects and to get help on a specific object use 'tkn &lt;object&gt; --help'</p>
</div>
</div>
</div>
<div class="paragraph">
<p>To execute the above pipeline use the following commands to create the pipeline objects. Note that when creating the taskrun objects the associated task(s) will run immediately.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f task-1.yaml
oc create -f taskrun-1.yaml
tkn taskrun ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response from the last command will display a line similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME          STARTED           DURATION      STATUS
task-run-1    9 seconds ago     ---           Running(Pending)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Repeat the final command a few times until you see it change to be similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME          STARTED           DURATION      STATUS
task-run-1    3 minutes ago    21 seconds    Succeeded</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of running the task can then be viewed by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn taskrun logs task-run-1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[echo-statement-1] This is my first task in Tekton

[echo-statement-2] ------------------------------------------------------------
[echo-statement-2]   - This is a multi-line comment
[echo-statement-2]   - This is useful as a separator but each line has
[echo-statement-2]   - the title repeated next to it using different colours
[echo-statement-2]   - which helps with the identification of different tasks.
[echo-statement-2]  ------------------------------------------------------------
[echo-statement-2]</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note that the command response above uses different colours for each block of command result titles in the [ ] brackets. This helps to differential between the response for each step.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pipelines"><a class="anchor" href="#pipelines"></a>Pipelines</h3>
<div class="paragraph">
<p>Pipelines are used to manage the execution of a series of tasks within a pipeline. The example pipeline below is used to execute the Tekton tasks : task-1, task-2 and task-3. Remember that each Tekton task can have multiple steps within it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: pipeline-1
spec:
  tasks:
  - name: task-1
    taskRef:
      name: task-1
  - name: task-2
    taskref:
      name: task-2
  - name: task-3
    taskref:
      name: task-3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before executing this pipeline create the required additional resources with the commands :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f task-2.yaml
oc create -f task-3.yaml
oc create -f pipeline-1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute the pipeline with the following Tekton task</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn pipeline start pipeline-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have executed the command switch back to the OpenShift console. If you select the Developer view you will find there is a menu option on the left hand side labelled 'Pipelines'. Select this option and the screen should look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-7.png" alt="Example Pipelines UI">
</div>
</div>
<div class="paragraph">
<p>Once the pipeline is indicated to have finished, go back to the terminal and enter the command suggested by the response to the tkn command - it will look similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn pipelinerun logs pipeline-1-run-kx95g -f</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the -n parameter is optional, it states the namespace to look in for the pipelinerun and we are running in a single namespace</p>
</div>
<div class="paragraph">
<p>Enter the command as provided by the tkn command and the response should look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Pipelinerun started: pipeline-1-run-ffxsk
Showing logs...
[task-2 : what-directory] /workspace

[task-2 : describe-command] ------------------------------------------------------------
[task-2 : describe-command]   - Openshift oc command line example
[task-2 : describe-command]  ------------------------------------------------------------
[task-2 : describe-command]

[task-2 : oc-version] Client Version: unknown
[task-2 : oc-version] Kubernetes Version: v1.14.6+76aeb0c

[task-3 : echo-statement-3] echo - statement 3
[task-1 : echo-statement-1] This is my first task in Tekton


[task-3 : echo-statement-4] echo - statement 4

[task-1 : echo-statement-2] ------------------------------------------------------------
[task-1 : echo-statement-2]   - This is a multi-line comment
[task-1 : echo-statement-2]   - This is useful as a separator but each line has
[task-1 : echo-statement-2]   - the title repeated next to it using different colours
[task-1 : echo-statement-2]   - which helps with the identification of different tasks.
[task-1 : echo-statement-2]  ------------------------------------------------------------</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
There may be an issue in the order of the execution above. The order of the pipeline expected is different to the order observed:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>   Expected               Actual
task 1 - step 1       task 2 - step 1
task 1 - step 2       task 2 - step 2
task 2 - step 1       task 2 - step 3
task 2 - step 2       task 3 - step 1
task 2 - step 3       task 1 - step 1
task 3 - step 1       task 3 - step 2
task 3 - step 2       task 1 - step 2</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In some pipelines the order of execution may not matter but if it does the order can be managed by the addition of the 'runAfter' directive to a specific task as shown in the update to the pipeline-1 pipeline shown below:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: pipeline-1
spec:
  tasks:
  - name: task-1
    taskRef:
      name: task-1
  - name: task-2
    taskref:
      name: task-2
    runAfter:
    - task-1
  - name: task-3
    taskref:
      name: task-3
    runAfter:
    - task-2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make the above changes to the pipeline-1.yaml file by using vi:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi pipeline-1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Press [ESC] then i to edit/insert, make the changes to the file, then press [ESC] and type :wq[RETURN] to save the changes</p>
</div>
<div class="paragraph">
<p>Now replace the existing pipeline using the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc delete pipeline pipeline-1
oc create -f pipeline-1.yaml
tkn pipeline start pipeline-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>As soon as you enter the last command switch back to the console and watch the pipeline complete, note the synchronous order of the steps.</p>
</div>
</div>
<div class="sect2">
<h3 id="viewing-pipelines-through-the-web-ui"><a class="anchor" href="#viewing-pipelines-through-the-web-ui"></a>Viewing pipelines through the Web UI</h3>
<div class="paragraph">
<p>In the OpenShift console you will see the pipeline recently created and it will show a green bar to the right indicating the previous successful execution of the pipeline, as shown below. Note that the green bar will display dark blue sections for running tasks, light blue sections for pending tasks, green for completed and red for failed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-3.png" alt="Pipeline view showing a completed pipeline run">
</div>
</div>
<div class="paragraph">
<p>From the three dot menu on the right hand side it is possible to start a run of the pipeline. Do this now and watch as the screen changes to show the details of the pipeline run as shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-4.png" alt="Pipelinerun in progress">
</div>
</div>
<div class="paragraph">
<p>Each block can be clicked on to show the details of the steps within the task. Experiment with the different screens to look at the details of the running or completed tasks.</p>
</div>
</div>
<div class="sect2">
<h3 id="task-inputs"><a class="anchor" href="#task-inputs"></a>Task inputs</h3>
<div class="paragraph">
<p>There will be scenarios where it is necessary to provide specific parameters to a pipeline process and the underlying tasks that the pipeline call.</p>
</div>
<div class="paragraph">
<p>There are two mechanisms for getting specific values into tasks :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>parameters - used to provide specific values to tasks at runtime. If a parameter is declared it must either have a default value defined within the task or it must have a value supplied from a calling taskrun or pipeline run.</p>
</li>
<li>
<p>pipeline resources - a reference to a defined resource object that can be accessed by a Tekton pipeline. If a resource is referenced by a task then the resource must exist unless it has been defined as an optional resource in the task definition.</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Pipeline Resource Types</div>
<div class="paragraph">
<p>The following pipeline resource types exist :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Git Resource - The git resource identifies a git repository, that contains the source code to be built by the pipeline. The resource can point to a specific branch or commit and can extract content from a specific directory.</p>
</li>
<li>
<p>Pull Request - Can be used as an input resource to identify specific meta data about a pull request. if used as an output a pull request can be updated with changes made during the pipeline process.</p>
</li>
<li>
<p>Image - An image to be created as part of the pipeline process.</p>
</li>
<li>
<p>Cluster Resource - A different cluster to the cluster on which the pipeline is running. This can be used to deploy content to an alternative cluster as part of a deployment pipeline process.</p>
</li>
<li>
<p>Storage Resource - Blob storage that contains either an object or directory.</p>
</li>
<li>
<p>Cloud Event Resource - A cloud event that is sent to a target URI upon completion of a TaskRun.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Further details on the options for all of the above resources is included here : <a href="https://github.com/tektoncd/pipeline/blob/master/docs/resources.md" target="_blank" rel="noopener">https://github.com/tektoncd/pipeline/blob/master/docs/resources.md</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="task-input-example"><a class="anchor" href="#task-input-example"></a>Task input example</h4>
<div class="paragraph">
<p>The task defined in task-4.yaml uses both parameters and pipeline resources to get information into the task. This allows a generic task to be written with specific values supplied to it from the taskrun. The Taskrun object acts as a 'value provider' giving specific values for parameters and referencing specific pipeline resources. The following diagram shows the relationship between the three specific objects.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-5.png" alt="Task and resource relationship">
</div>
</div>
<div class="paragraph">
<p>As shown above the task has place-holders for two parameters. The first parameter has a value defined within the taskrun. The second parameter has a default value so it is not essential to provide a value for it in the taskrun. Both parameters are referenced from the steps of the task using the notation $(inputs.params.&lt;parameter-name&gt;).</p>
</div>
<div class="paragraph">
<p>The task also defines a resource object called git-repo-simple-rest of type git. Within the taskrun an input resource object is defined with the same name (git-repo-simple-rest) referring to a pipeline resource object called git-repo-simple-rest-resource. A pipeline resource object is created from the yaml file git-resources.yaml which makes a reference to the actual git repository.</p>
</div>
<div class="paragraph">
<p>To create the resource object go back to the terminal app and execute the following command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f git-resources.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>To view the resources in the project use the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn resources list</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response will be :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME                      TYPE   DETAILS
git-repo-simple-rest-resource   git    url: https://github.com/marrober/simpleRest.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>To execute task 4 and view the output execute the following commands :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f task-4.yaml
oc create -f taskrun-4.yaml
tkn taskrun ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>Repeat the final command a few times until task-run-4 has a status of Succeeded. When the task has completed execute the command below to see the output results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn taskrun logs task-run-4</code></pre>
</div>
</div>
<div class="paragraph">
<p>The use of pipeline resource objects for git repositories and created images (as output resources) helps teams to create generic build, test and deploy pipelines that can be reused across multiple projects where the projects simply define the custom pipeline resource objects that are specific to their project or environment.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="workspaces-and-volumes"><a class="anchor" href="#workspaces-and-volumes"></a>Workspaces and Volumes</h3>
<div class="paragraph">
<p>Workspaces allow you to organize the content used by tasks and the assets that are produced by tasks. This can be useful to add structure to the content during large complex pipelines.</p>
</div>
<div class="paragraph">
<p><strong>Workspaces</strong> are storage structures within the pod that runs the containers of the pipeline and workspaces are scoped at the task level. Separate steps within a task can see the same workspace.</p>
</div>
<div class="paragraph">
<p><strong>Volumes</strong> are similar to workspaces except for the fact that they are backed by persistent volumes. This ensures that content written to the volume is accessible by steps from multiple tasks, allowing for a greater separation of steps into different tasks. For example a generic build task could be used to create an executable, writing the deliverable to a volume. A separate testing task could then be invoked by a pipeline to perform tests against the newly created deliverable. Accessing the file via a volume will work for the two separate tasks.</p>
</div>
<div class="paragraph">
<p>Task 5 has steps for creating files in the workspace and in a volume, followed by steps to display the files in the workspace and the volume which work fine. Task 6 only has tasks for attempting to display the content of the workspace and the volume. Since the workspace in task 6 is a different workspace to that used in task 5 there is no content to display. The volume however shows the file written in the step in task 5. Tasks 5 and 6 are orchestrated by the pipeline called pipeline-5.</p>
</div>
<div class="paragraph">
<p>Create the persistent volume claim to use in this exercise with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f persistentvolumeclaim.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create tasks 5 and 6:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f task-5.yaml
oc create -f task-6.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the pipeline task:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f pipeline-5.yaml</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The persistent volume will show that it is in a pending state after creation as no resource has attempted to consume it. After the task has been executed look again at the persistent volume and it will show that it is bound.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To see the state of the pvc enter the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pvc</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before executing the task the state of the pvc should be as follows</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME                    STATUS        VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
tekton-task-cache-pvc   Pending                                                                            gp2            4s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the pipeline has completed (you will run it after this) the pvc will indicate itself as bound - try it after the pipeline has completed</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME                    STATUS        VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
tekton-task-cache-pvc   Bound         pvc-1d894a93-2646-11ea-9f45-0a9970779e5c   1Gi        RWO            gp2            2m2s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute the pipeline using the following command in the terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn pipeline start pipeline-5</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now switch to the OpenShift console. Select the Pipelines entry on the left side of the Developer panel.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-8.png" alt="Two completed pipelines">
</div>
</div>
<div class="paragraph">
<p>You can click on the pipeline-run (labelled pipeline-5-run-XXXXX) and examine the logs for each of the tasks.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-9.png" alt="Task details">
</div>
</div>
<div class="paragraph">
<p>To examine the pipeline run in the terminal window use the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn pipelinerun logs pipeline-5-run-XXXXX</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace the XXXX with the information reported on screen after the execution of the tkn pipeline start command.</p>
</div>
<div class="paragraph">
<p>The output will be similar to that that is shown below. Within task 5 the first step creates a file called /workspace/message. The second step displays the file name and the content of the file within the workspace. The third step creates a file in the persistent volume and the fourth step displays the file name and the content of the file within the volume.</p>
</div>
<div class="paragraph">
<p>Within task 6 the first step displays the contents of the workspace. Note that this is empty because the workspace is unique to the task. The second step of task 6 shows the content of the persistent volume which is the same a that which was reported for step 5. This shows that workspaces can be used for sharing data between steps in the same task and volumes should be used for sharing data between steps within different tasks.</p>
</div>
<div class="paragraph">
<p>[task-5 : create-a-file-in-workspace] /workspace/message</p>
</div>
<div class="paragraph">
<p>[task-5 : view-workspace-content] message
[task-5 : view-workspace-content] This is a file in the workspace</p>
</div>
<div class="paragraph">
<p>[task-5 : create-a-file-in-volume] /var/run/message</p>
</div>
<div class="paragraph">
<p>[task-5 : view-volume-content] lost+found
[task-5 : view-volume-content] message
[task-5 : view-volume-content] secrets
[task-5 : view-volume-content] This is a file in the volume</p>
</div>
<div class="paragraph">
<p>[task-6 : view-workspace-content] view workspace content
[task-6 : view-workspace-content] total 0
[task-6 : view-workspace-content] drwxrwsrwx. 2 root 1000800000  6 May  1 14:17 .
[task-6 : view-workspace-content] drwxr-xr-x. 1 root root       37 May  1 14:17 ..</p>
</div>
<div class="paragraph">
<p>[task-6 : view-volume-content] lost+found
[task-6 : view-volume-content] message
[task-6 : view-volume-content] secrets
[task-6 : view-volume-content] This is a file in the volume</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understanding-persistent-volumes-essentials"><a class="anchor" href="#understanding-persistent-volumes-essentials"></a>Understanding Persistent Volumes [ESSENTIALS]</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Ian Lawson (feedback to <a href="mailto:ian.lawson@redhat.com">ian.lawson@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction-8"><a class="anchor" href="#introduction-8"></a>Introduction</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">Persistent Volumes</div>
<div class="paragraph">
<p>Most Applications require the ability to store information that persists after they are gone. With the approach that OpenShift and Kubernetes have to Applications, which is that they should really be able to be destroyed and recreated, this causes some issues.</p>
</div>
<div class="paragraph">
<p>If you have an Application running as a Pod and, say, the Node on which it is running goes down, then OpenShift will automatically recreate it somewhere within the Cluster. This recreation is done from the Image, along with things such as Config Maps and Secrets which can change files in the Container and Environment variables. But the Application cannot change these things, the image containing the filesystem or the provided Config Maps and Secrets.</p>
</div>
<div class="paragraph">
<p>OpenShift provides the concept of 'Persistent Volumes'. These are filesystems expressed as directories into the Container on creation but actually stored away from the Container - this means the Application can use the filesystem as with any filesystem but the contents remain in the volume when the Container is removed.</p>
</div>
<div class="paragraph">
<p>This means wherever the Container is hosted within the Cluster it has the Persisted Volume attached, which means that the data in that volume can survive loss of the Application.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setting-up-the-lab"><a class="anchor" href="#setting-up-the-lab"></a>Setting up the lab</h3>
<div class="paragraph">
<p>If you are not already logged on go to the UI URL <a href="https://https" target="_blank" rel="noopener">https://https</a> and logon as userx (x is the number provided to you) and password openshift.</p>
</div>
<div class="paragraph">
<p>If you do not already have a terminal tab running as defined in the pre-requisites please open one following the instructions in the pre-requisites</p>
</div>
<div class="paragraph">
<p>Ensure you are on the Administrator View (top level, select Administrator)</p>
</div>
<div class="paragraph">
<p>Click on ‘Create Project’</p>
</div>
<div class="paragraph">
<p>Enter ‘pvtest*x*’ for the name, where <strong>x</strong> is your user number</p>
</div>
<div class="paragraph">
<p>Enter ‘PV Test’ for the Display Name and Description</p>
</div>
<div class="paragraph">
<p>Hit ‘Create’</p>
</div>
<div class="paragraph">
<p>Switch to the Developer UI (click on Developer in the top left pulldown)</p>
</div>
<div class="paragraph">
<p>Select ‘From Catalog’</p>
</div>
<div class="paragraph">
<p>Search for ‘node’</p>
</div>
<div class="paragraph">
<p>Click on the ‘node.js’ option</p>
</div>
<div class="paragraph">
<p>Click ‘Create Application’</p>
</div>
<div class="paragraph">
<p>Leave the Builder Image Version as ‘10’</p>
</div>
<div class="paragraph">
<p>Enter the following for the Git Repo URL - ‘https://github.com/utherp0/workshop4’</p>
</div>
<div class="paragraph">
<p>Click on ‘Show Advanced Git Options’</p>
</div>
<div class="paragraph">
<p>In Context Dir put ‘/apps/nodeatomic’</p>
</div>
<div class="paragraph">
<p>In Application Name put ‘nodeatomic’</p>
</div>
<div class="paragraph">
<p>In Name put ‘nodeatomic’</p>
</div>
<div class="paragraph">
<p>Scroll down to Resources and click on DeploymentConfig</p>
</div>
<div class="paragraph">
<p>Click on ‘Create’</p>
</div>
<div class="paragraph">
<p>When the Topology page appears click on the node Pod to see the information window</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pvs-1.png" alt="Active Application">
</div>
</div>
<div class="paragraph">
<p>Ensure the build completes correctly - watch the Developer/Topology page until the Pod is dark blue</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
What we have done is to create a simple application running in a Pod. We will use this Application to show the power of Persistent Volumes
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="adding-a-persistent-volume-to-an-application"><a class="anchor" href="#adding-a-persistent-volume-to-an-application"></a>Adding a Persistent Volume to an Application</h3>
<div class="paragraph">
<p>Ensure you are on the Developer/Topology page. Make sure the DC tab is visible for the Application (if it isn&#8217;t click on the Node Pod in the Topology tab).</p>
</div>
<div class="paragraph">
<p>In the DC tab click on the Resources tab. This shows the Pods, Builds, Services and Routes for this Application. You will have one Pod - click on the Pod name in the tab.</p>
</div>
<div class="paragraph">
<p>In the Pod Details tab click on the Terminal tab. This will start a terminal window</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We are now going to enter commands directly into the Pod itself. The Pod thinks it is an OS; in fact it is a contained file system running on a Worker Node
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Type the following into the Terminal window:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>df -h</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see a response similar to this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pvs-2.png" alt="df with no pv">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This command returns all the file mounts that the 'Operating System' has. In this case you will see an 'overlay' filesystem mounted on the root of the Container, at the '/' directory. This is the Container file system, created from the immutable image and now operating as effectively an OS
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we are going to create a test file in this Container. Type the following into the Terminal window:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd
pwd
ls -al &gt; listing.txt
ls -al listing.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>What we have done is moved to the home directory (using 'cd'), printed the working directory, listed all the files in that directory and outputted them to a text file, and then confirmed the text file exists.</p>
</div>
<div class="paragraph">
<p>Now we are going to force the Application to redeploy. Click on 'Topology' in the left hand menu. Click on the node Application to get the DC tab up on the right.</p>
</div>
<div class="paragraph">
<p>Now click on the Pod name again, which will take you to the Pod Details page. On the far right is a pulldown marked 'Action'. Click on that, and in the pulldown select 'Delete Pod'. When prompted on whether to delete it, click 'Delete' to delete it.</p>
</div>
<div class="paragraph">
<p>The system will take you the Pods tab and you will see, if you are quick, the Pod deleting and OpenShift instantly recreating it. This is the strength of OpenShift.</p>
</div>
<div class="paragraph">
<p>Now in the Pods tab click on the name of the new Pod (it will be something like nodeatomic-1-xxxxx). This takes you to the Pod Details for the new Pod. Click on the Terminal tab to get a terminal again.</p>
</div>
<div class="paragraph">
<p>Now type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd
pwd
ls listing.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see that the file we created in the Application file space no longer exists</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This is what we described earlier. When the Pod is deleted the new instance can only be created from the Image plus additional files via Config Maps and Secrets. Any state change to the filesystem done by the previous Pod is instantly discarded
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we will add a Persistent Volume to the Application. To do this we need to change the Deployment Config of the Application - this defines how the Application is orchestrated within OpenShift</p>
</div>
<div class="paragraph">
<p>Switch to the Administrator viewpoint by clicking on Developer at the top left and select Administrator. Open the Deployment Configs tab by clicking on Workloads/Deployment Configs (not deployments - these are the Kubernetes deployment objects that are a less functional way of deploying an Application).</p>
</div>
<div class="paragraph">
<p>There should be one DC listed with the name 'nodeatomic'. Click on the name to get the Deployment Config Details tab. This shows the number of active Pods and information about the deployment config</p>
</div>
<div class="paragraph">
<p>Now select the Action menu at the top right and choose 'Add Storage'</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Persisent Volumes and Persistent Volume Claims</div>
<div class="paragraph">
<p>OpenShift implements storage using three distinct objects:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Persistent Volumes (PV)</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These are the actual physical storage units. With storage providers that don&#8217;t have dynamic storage provision these units are pre-created and can then be assigned to a deployment config (which represents the Application) using the next object, the Persistent Volume Claim (PVC). When a PV is created, be it in advance or dynamically, you can configure the retention strategy. This is 'retain' or 'delete'. With a 'delete' strategy when <strong>all</strong> references to the PV are removed (i.e. PVCs, deployments and the like) the storage unit is physically deleted. With 'retain' the file contents of the PV remain - this is for the case where you want to remove all of the application footprint from the cluster but want to retain its data for later recreation. In this case the PV remains unbounded.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Persistent Volume Claim (PVC)</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When an Application claims a PV (or has one created dynamically) the PVC defines how the PV is expressed into the Application. You can think of this as the configuration for the application&#8217;s use of the filesystem. The PVC defines, for example. the access mode. This is discussed in detail later in the lab.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Storage Class (SC)</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>OpenShift administrators and storage providers can setup RBAC defined classes which are a template for creating PVs and PVCs. This is to allow multiple levels of storage types and control who can use them - for instance you could have a 'SLOW' storage class that assigned to less powerful storage and had a fixed size.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we will add a PVC to our application - at the 'Add Storage' tab you will see a heading for 'Persistent Volume Claim'. We haven&#8217;t created a claim so click the select box for 'Create new claim'</p>
</div>
<div class="paragraph">
<p>The screen should look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pvs-4.png" alt="create new claim">
</div>
</div>
<div class="paragraph">
<p>Most of the workshops use AWS so there should be a class called 'gp2'. Leave that selected.</p>
</div>
<div class="paragraph">
<p>In the Persistent Volume Claim Name type 'nodeatomicclaim'</p>
</div>
<div class="paragraph">
<p>Now look at the Access Mode. This is very important. With AWS EBS you only have the option of RWO and this should be preselected.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Persistent Volume Access Modes</p>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>OpenShift supports three distinct modes for storage behaviours and these are very important.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Single User (RWO)</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When the storage is set to RWO this creates a single copy of the storage. This storage is assigned and mounted onto the <strong>first</strong> Node where an Application lands - if you have multiple copies of the Application and they are on separate Nodes the first one will get the storage and the subsequent ones will <strong>not</strong> be able to start up.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Shared Access (RWX)</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This type of storage is <strong>singular</strong> across the Cluster. This means that all copies of the Application will have access to the <strong>same</strong> piece of storage. This is very useful but currently only supported if the storage mechanism is NFS or Azure Disk.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Read Only (ROX)</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This type of storage is <strong>singular</strong> across the Cluster but is read only.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Set the size of the PVC to 1GB (enter 1 in the textbox and leave the units as GiB)</p>
</div>
<div class="paragraph">
<p>Set the Mount Path to '/labs/storage'</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Be very careful with the mount point. You can overwrite existing files and directories in the Container image. If you use subpath you can actually spoof the Container (i.e. inject your own executables). This is a powerful feature by design.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hit 'Save'</p>
</div>
<div class="paragraph">
<p>The interface will shift to the Deployment Config Details and a deployment will automatically start. This is because we have physically changed the deployment config and by default OpenShift will automatically redeploy if the configuration of the deployment <strong>or</strong> the image that is used for the deployment are changed</p>
</div>
<div class="paragraph">
<p>Whilst deploying the screen will look like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pvs-5.png" alt="deployment">
</div>
</div>
<div class="paragraph">
<p>Once the deployment has finished and one Pod is displayed, click on the 'Pods' tab of the Deployment Config Details tab. There should be one pod and it should be called something like 'nodeatomic-2-zzzzz' (the '2' indicates the version of the deployment). Click on the Pod name.</p>
</div>
<div class="paragraph">
<p>In the Pod Details tab click on the Terminal tab. This opens a Terminal into the new Pod.</p>
</div>
<div class="paragraph">
<p>Type the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>df -h</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see an extra disk mount. This is the Persistent Volume but as far as the Container is concerned it is now a part of the file system. Type the following commands in the Terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /labs/storage
ls -al $HOME &gt; listing.txt
ls -al</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see a file having been created. If you look carefully at the output the file should be listed something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>-rw-r--r--. 1 1000670000 1000670000   903 Jun 25 09:49 listing.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>This file is owned by the UID for the Container, and the permissions are RW for that UID.</p>
</div>
</div>
<div class="sect2">
<h3 id="storage-surviving-application-loss"><a class="anchor" href="#storage-surviving-application-loss"></a>Storage surviving Application loss</h3>
<div class="paragraph">
<p>What we are going to do now is remove the Application. Instead of deleting the Pod, and having OpenShift automatically recreate it, we are going to scale the deployment down to zero replicas, which will get rid of the Application completely.</p>
</div>
<div class="paragraph">
<p>Switch back to the Developer view (click on Administrator and choose Developer). Make sure the Topology is showing and click on the node Pod. When the Deployment tab appears on the right-hand side, click on the Overview tab.</p>
</div>
<div class="paragraph">
<p>This displays the overview of the Deployment Config. You will see a representation of the Application shown as a Pod with the number 1 in the middle. Next to the icon are two arrows - these are used to scale up and down the number of replicas. Click on the down arrow and set the replicas for the Application to zero.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pvs-6.png" alt="scaled down application">
</div>
</div>
<div class="paragraph">
<p>Click on the Resources tab and make sure there are no Pods running - the message will say 'No Pods found for this resource'.</p>
</div>
<div class="paragraph">
<p>Now click on Developer and switch back to the Adminstrator view. On the left hand menu click on Storage/Persistent Volume Claims. You will see the PVC is still bound even though we have no replicas of the Application. It remains resident at this point.</p>
</div>
<div class="paragraph">
<p>Switch back to the Developer view. In the Topology click on the empty node. In the Deployment Config tab click on Overview. You will see the 'scale down' arrow is grayed out because we have no replicas. Scale the count back up to 1 (make sure you only scale to 1 at this point).</p>
</div>
<div class="paragraph">
<p>When the Pod has started (dark blue circle) click on Resources. You will see a new Pod has spun up (it will have a different set of five letters at the end of the Pod). Click on the Pod name.</p>
</div>
<div class="paragraph">
<p>When the Pod Details tab appears click on Terminal again.</p>
</div>
<div class="paragraph">
<p>Type the following commands in the Terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /labs/storage
cat listing.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file has survived the removal of the Application. This is the strength and capabilities offered through Persistent Volumes.</p>
</div>
</div>
<div class="sect2">
<h3 id="demonstrating-the-rwo-behaviour"><a class="anchor" href="#demonstrating-the-rwo-behaviour"></a>Demonstrating the RWO behaviour</h3>
<div class="paragraph">
<p>Click on Topology. Click on the node icon. When the Deployment Config tab appears click on Overview.</p>
</div>
<div class="paragraph">
<p>Click on the up arrow to scale the Application to two copies. This will <strong>fail</strong>. The second Pod will hang in Pending.</p>
</div>
<div class="paragraph">
<p>Click on Advanced/Events in the left hand menu. You should see an Event highlighted in red that looks similar to the screen below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pvs-7.png" alt="unable to attach the volume">
</div>
</div>
<div class="paragraph">
<p>The volume is RWO, meaning only one node can have it at once. OpenShift will load balance the Application copies, so it is highly unlikely the two Pods will land on the same node.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You <strong>may</strong> get a situation where the two Pods do start. This is when they have both landed on the same Worker node.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on Topology. Click on the node icon (it will show one Pod active and one Pod pending). In the Deployment Config tab make sure you are on the Overview tab. Scale the application back to one copy. OpenShift will delete the pending Pod and the Application will return to a single working copy.</p>
</div>
</div>
<div class="sect2">
<h3 id="summary-and-clean-up"><a class="anchor" href="#summary-and-clean-up"></a>Summary and clean-up</h3>
<div class="paragraph">
<p>What you have seen is the creation, assigning and use of a piece of persisted storage within an Application on OpenShift. The concept of PVs is incredibly powerful and useful - for instance you could store sticky session state for an Application in a PV. In fact, a lot of the persisted applications offered on OpenShift, such as databases and the like, use PVs to retain their state.</p>
</div>
<div class="paragraph">
<p>To clean-up the lab, switch to Adminstrator view, select Home/Projects. Click on the three dot menu at the far right of the entry for pvtest*x* (where x is your user number) and select Delete Project. Confirm deletion by typing the project name when prompted.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-rbac-model-for-developers-essentials"><a class="anchor" href="#the-rbac-model-for-developers-essentials"></a>The RBAC model for Developers [ESSENTIALS]</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="introduction-9"><a class="anchor" href="#introduction-9"></a>Introduction</h3>
<div class="paragraph">
<p><strong>This chapter will introduce the attendee to the concepts around the Role Based Access Control model integrated into OpenShift. This will cover the use of Users, Service Accounts and Permissions.</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For the majority of this chapter the attendee will need to pair up with another. If the numbers are odd the presenter should fill the gap of the missing attendee - pair the attendees up before the chapter starts and get them to exchange numbers - remember the numbers as MYUSER and PARTNERUSER
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you are not already logged on go to the UI URL <a href="https://https" target="_blank" rel="noopener">https://https</a> and logon as 'userx' (x is the number provided to you) and password openshift.</p>
</div>
<div class="paragraph">
<p>If you do not already have a terminal tab running as defined in the pre-requisites please open one following the instructions in the pre-requisites</p>
</div>
<div class="paragraph">
<p>Ensure you are on the Administrator View (top level, select Administrator)</p>
</div>
<div class="paragraph">
<p>In the UI click on 'Home/Projects'</p>
</div>
<div class="paragraph">
<p>Click on 'Create Project'</p>
</div>
<div class="paragraph">
<p>For the project name give it rbactestx where x is your user number</p>
</div>
<div class="paragraph">
<p>Display Name and Description are optional</p>
</div>
<div class="paragraph">
<p>Click on 'Create'</p>
</div>
</div>
<div class="sect2">
<h3 id="examining-service-accounts"><a class="anchor" href="#examining-service-accounts"></a>Examining Service Accounts</h3>
<div class="paragraph">
<p>Once the project has been created, click on 'User Management/Service Accounts'</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/rbac-1.png" alt="List of Service Accounts">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Service Accounts are effectively virtual users - even though you have logged on when you do anything within the namespace, such as a build or a deployment, the namespace uses a virtual user, with appropriate permissions, to do the actual tasks internally, like pushing a built image to the registry, or pulling an image to start a Container.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Each project gets a Service Account by default, named default or to give it its full name system:serviceaccount:rbactestx:default (where x is your number). There are also Service Accounts for doing the appropriate actions, such as Builder and Deployer</strong></p>
</div>
<div class="paragraph">
<p><strong>In addition further Service Accounts can be created by the project owner and given additional security details and roles, such as being able to execute Containers as root, or giving Containers specific controlled sec-comp profiles (like changing the Group ID for the process)</strong></p>
</div>
<div class="paragraph">
<p>Switch to the Developer view using the top left pulldown</p>
</div>
<div class="paragraph">
<p>In the Topology Tab click on ‘From Catalog’</p>
</div>
<div class="paragraph">
<p>In the search box enter ‘node’. Select the Node.js option</p>
</div>
<div class="paragraph">
<p>Click ‘Create Application’</p>
</div>
<div class="paragraph">
<p>Default the image to version 10</p>
</div>
<div class="paragraph">
<p>For the git repo enter ‘https://github.com/utherp0/nodenews’</p>
</div>
<div class="paragraph">
<p>Set the Application Name to ‘rbac’</p>
</div>
<div class="paragraph">
<p>Set the Name to ‘rbactest’</p>
</div>
<div class="paragraph">
<p>In Resources set the deployment to DeploymentConfig</p>
</div>
<div class="paragraph">
<p>Click 'Create'</p>
</div>
<div class="paragraph">
<p>Click on the Node pod indicator so the informational panel appears</p>
</div>
<div class="paragraph">
<p>Watch the build and ensure it completes</p>
</div>
<div class="paragraph">
<p>Once the build is complete ensure the deployment occurs. The Pod ring will turn dark blue</p>
</div>
<div class="paragraph">
<p>Switch back to Administrator view using the top left selection point</p>
</div>
<div class="paragraph">
<p>Click on User Management/Role Bindings</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/rbac-2.png" alt="Admin Role">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note that we have one Role Binding shown at the moment, which is for Admin and applies to a kind of 'user' and a subject name of 'userx'. This is the binding of your user to the administration role within the project.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on the 'System Role Bindings'</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/rbac-3.png" alt="System Role Bindings">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note that with the addition of System Role Bindings to the screen we can now see the three Service Accounts also created. Deployer is part of the system:deployers binding, builder is part of the system:image-builders binding and the group of users under system:serviceaccounts:rbactestx (where x is your number) have the system:image-pullers binding.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on the (CR) admin Role Ref</p>
</div>
<div class="paragraph">
<p><strong>This screen displays ALL the actions, via API, that this role has access to grouped by the API groups. This mapping is what controls what the user can do via the bindings they have.</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="adding-role-bindings-to-your-namespaceproject"><a class="anchor" href="#adding-role-bindings-to-your-namespaceproject"></a>Adding Role Bindings to your namespace/project</h3>
<div class="paragraph">
<p>Click on 'User Management/Role Bindings'</p>
</div>
<div class="paragraph">
<p>Click on 'Create Binding'</p>
</div>
<div class="paragraph">
<p>Set Name to ‘partneraccess’</p>
</div>
<div class="paragraph">
<p>Select ‘rbactestx’ from the Namespace pulldown; it should be the only one.</p>
</div>
<div class="paragraph">
<p><strong>As a user with the admin role within the namespace/project you can add other users with role bindings within your project.</strong></p>
</div>
<div class="paragraph">
<p>Select ‘Admin’ in the Role Name pulldown</p>
</div>
<div class="paragraph">
<p>Ensure ‘User’ is selected in the radiobox for Subject</p>
</div>
<div class="paragraph">
<p>Enter ‘userPARTNERUSER’ for the Subject Name</p>
</div>
<div class="paragraph">
<p><strong>What we are doing is adding the user you have chosen to pair with as an admin role binding within your project.</strong></p>
</div>
<div class="paragraph">
<p>Click 'Create'</p>
</div>
<div class="paragraph">
<p>Ensure the partner has done the same with your userx</p>
</div>
<div class="paragraph">
<p>Click on Home/Projects</p>
</div>
<div class="paragraph">
<p><strong>If the partner user has set the role binding appropriately you will now see two projects - your own and the other person&#8217;s</strong></p>
</div>
<div class="paragraph">
<p>Click on the partner’s project (rbactestPARTNERUSER)</p>
</div>
<div class="paragraph">
<p>Change to the Developer view using the top left selection point</p>
</div>
<div class="paragraph">
<p>Ensure you can see the Topology page</p>
</div>
<div class="paragraph">
<p>Change back to the Administrator view using the top left selection point</p>
</div>
<div class="paragraph">
<p>Select 'Workloads/Deployment Configs'</p>
</div>
<div class="paragraph">
<p>Ensure that the ‘rbactest’ DC shown has a Namespace that is the Partner’s project</p>
</div>
<div class="paragraph">
<p>Click on the DC rbactest</p>
</div>
<div class="paragraph">
<p>Using the arrows scale the deployment to 4 pods</p>
</div>
<div class="paragraph">
<p>Click on 'Home/Projects' and select your project (rbactestMYUSER)</p>
</div>
<div class="paragraph">
<p>Click on ‘Role Bindings’ in the project overview pane</p>
</div>
<div class="paragraph">
<p>On the triple dot for ‘partneraccess’ choose ‘Delete’</p>
</div>
<div class="paragraph">
<p>Confirm deletion in the pop-up message box</p>
</div>
</div>
<div class="sect2">
<h3 id="giving-users-lower-levels-of-permission"><a class="anchor" href="#giving-users-lower-levels-of-permission"></a>Giving Users lower levels of permission</h3>
<div class="paragraph">
<p>Click on 'User Management/Role Bindings'</p>
</div>
<div class="paragraph">
<p>Click on 'Create Binding'</p>
</div>
<div class="paragraph">
<p>Set Name to ‘partneraccess’</p>
</div>
<div class="paragraph">
<p>Choose the ‘rbactestMYUSER’ in the Namespace pulldown</p>
</div>
<div class="paragraph">
<p>Select ‘view’ in the Role Name pull down</p>
</div>
<div class="paragraph">
<p>Ensure the Subject radiobox is set to ‘User’</p>
</div>
<div class="paragraph">
<p>In the Subject Name enter the user name for the partner (userPARTNERUSER)</p>
</div>
<div class="paragraph">
<p>Click Create</p>
</div>
<div class="paragraph">
<p>Ensure the partner has done the same with your userx</p>
</div>
<div class="paragraph">
<p>Click on 'Home/Projects'</p>
</div>
<div class="paragraph">
<p>Select the partner project (rbactestPARTNERUSER)</p>
</div>
<div class="paragraph">
<p>In the Project overview pane click on Role Bindings</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You now do not have the appropriate access rights to interact with the role bindings as you only have View access to the target project
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on 'Workloads/Deployment Config'</p>
</div>
<div class="paragraph">
<p>Click on the rbactest (DC)</p>
</div>
<div class="paragraph">
<p>Try and scale down the Pod to one pod</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
View access allows you to see the state of objects but NOT to change them.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on 'Home/Projects'</p>
</div>
<div class="paragraph">
<p>In the triple dot menu next to the rbactestPARTNERUSER select ‘Delete Project’</p>
</div>
<div class="paragraph">
<p>Type ‘rbactestPARTNERUSER’ in the message box and press ‘Delete’</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that you cannot delete the other persons project.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hit Cancel</p>
</div>
<div class="paragraph">
<p>In the triple dot menu next to your own project (rbactestMYUSER) select ‘Delete Project’</p>
</div>
<div class="paragraph">
<p>Type ‘rbactestMYUSER’ in the message box and press ‘Delete’</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understanding-the-software-defined-network-essentials"><a class="anchor" href="#understanding-the-software-defined-network-essentials"></a>Understanding the Software Defined Network [ESSENTIALS]</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="introduction-10"><a class="anchor" href="#introduction-10"></a>Introduction</h3>
<div class="paragraph">
<p>This chapter provides a developer-centric view of the fundamentals and capabilities of the SDN (Software Defined Network) that is used within OpenShift for Application connectivity.</p>
</div>
<div class="paragraph">
<p>If you are not already logged on go to the UI URL at <a href="https://https" target="_blank" rel="noopener">https://https</a> and logon as 'userx' (x is the number provided to you) and password openshift.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-basics-of-service-addressing"><a class="anchor" href="#the-basics-of-service-addressing"></a>The basics of Service Addressing</h3>
<div class="paragraph">
<p><strong>In this section we will create a couple of simple applications and show how they are represented via the Service and load-balancing of Pods within the SDN itself.</strong></p>
</div>
<div class="paragraph">
<p>If you do not already have a terminal tab running as defined in the pre-requisites please open one following the instructions in the pre-requisites</p>
</div>
<div class="paragraph">
<p>Ensure you are on the Administrator View (top level, select Administrator)</p>
</div>
<div class="paragraph">
<p>Select Home/Projects</p>
</div>
<div class="paragraph">
<p>Click on ‘Create Project’</p>
</div>
<div class="paragraph">
<p>For the project name give it networktestx where x is your user number</p>
</div>
<div class="paragraph">
<p>Display Name and Description are optional</p>
</div>
<div class="paragraph">
<p>Click on 'Create'</p>
</div>
<div class="paragraph">
<p>Using the top left selection switch the UI from Administrator to Developer</p>
</div>
<div class="paragraph">
<p>In the Topology Tab click on ‘From Catalog’</p>
</div>
<div class="paragraph">
<p>In the search box enter ‘node’. Select the Node.js option</p>
</div>
<div class="paragraph">
<p>Click ‘Create Application’</p>
</div>
<div class="paragraph">
<p>Default the image to version 10</p>
</div>
<div class="paragraph">
<p>For the git repo enter ‘https://github.com/utherp0/nodenews’</p>
</div>
<div class="paragraph">
<p>Set the 'Application Name' to ‘application1-app’</p>
</div>
<div class="paragraph">
<p>Set the 'Name' to 'application1'</p>
</div>
<div class="paragraph">
<p>In Resources set the deployment type to DeploymentConfig</p>
</div>
<div class="paragraph">
<p>Click 'Create'</p>
</div>
<div class="paragraph">
<p>Click on ‘+Add’</p>
</div>
<div class="paragraph">
<p>Click on ‘From Catalog’</p>
</div>
<div class="paragraph">
<p>In the search box enter ‘node’. Again select the Node.js option</p>
</div>
<div class="paragraph">
<p>Click ‘Create Application’</p>
</div>
<div class="paragraph">
<p>For the git repo enter ‘https://github.com/utherp0/nodenews’</p>
</div>
<div class="paragraph">
<p>Choose 'Create Application' from the Application pulldown</p>
</div>
<div class="paragraph">
<p>Set the 'Application Name' to 'application2-app'</p>
</div>
<div class="paragraph">
<p>Set the Name to ‘application2’</p>
</div>
<div class="paragraph">
<p>In Resources set the deployment type to DeploymentConfig</p>
</div>
<div class="paragraph">
<p>Click 'Create'</p>
</div>
<div class="paragraph">
<p>Wait until both applications have built and deployed. The Topology view will look similar to the image below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/sdn-1.png" alt="Both Applications Loaded">
</div>
</div>
<div class="paragraph">
<p>Once the applications have created change the mode from Developer to Administrator using the top left selection point</p>
</div>
<div class="paragraph">
<p>Click on 'Projects'. Select the networktestx project</p>
</div>
<div class="paragraph">
<p>Click on 'Networking/Services'</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/sdn-2.png" alt="Example Services">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The Services UI shows the services currently available in the Project. Note that there is a Service per application, so in this case there are two Services, application1 and application2. The Location is a singular IP address for each Service within the SDN - more on this later.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on 'Workloads/Deployment Configs'</p>
</div>
<div class="paragraph">
<p>Click on the application1 dc</p>
</div>
<div class="paragraph">
<p>Using the arrows next to the Pod indicator scale the application to three replicas</p>
</div>
<div class="paragraph">
<p>Click on ‘Pods’ in the DC view (not Workloads/Pods)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/sdn-3.png" alt="Pod Listing">
</div>
</div>
<div class="paragraph">
<p>Click on the first active Pod for application1 listed</p>
</div>
<div class="paragraph">
<p>Scroll down and take a note of the IP address for the Pod</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/sdn-4.png" alt="Highlighted Pod IP">
</div>
</div>
<div class="paragraph">
<p>Click on 'Networking/Services'</p>
</div>
<div class="paragraph">
<p>Click on the application1 service</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note that the IP address for the Service has NOT changed. Scaling the Application has no impact on the singular IP address for the Service, which in actuality acts as a load-balancer across ALL of the IP addresses for the Pods of that Application.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="using-the-shorthand-service-name-directly"><a class="anchor" href="#using-the-shorthand-service-name-directly"></a>Using the shorthand Service name directly</h3>
<div class="paragraph">
<p>Click on 'Workloads/Pods'</p>
</div>
<div class="paragraph">
<p>Click on the first running Pod for application1 (the name will be application1-1-(something)</p>
</div>
<div class="paragraph">
<p>Click on Terminal</p>
</div>
<div class="paragraph">
<p>In the Terminal window type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl http://localhost:8080</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You will see the webpage for the Application as a return from the curl statement. The Container sees itself as localhost. Also note that because we are calling from within the Container we use the port address - if you were using the Routes their would be a Route for every Service, with no port address.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the Terminal window type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl http://application1:8080</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This is where it starts to get interesting. The Service 'name' itself is exported into the network namespace of the Container so it can refer to it as a short name. The SDN translates the service name into the service IP - in reality this Container could be getting a webpage back from any of the Application Pods that satisfy this Service.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="using-the-fully-qualified-domain-name-for-accessing-services"><a class="anchor" href="#using-the-fully-qualified-domain-name-for-accessing-services"></a>Using the Fully Qualified Domain Name for accessing Services</h3>
<div class="paragraph">
<p>In the Terminal window type (and replace x with your number):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl http://application1.networktestx.svc.cluster.local:8080</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
And this is the fully qualified version of the Service. by including the namespace/project name we can reach, effectively, any service on the SDN assuming the SDN has been configured to allow that. In this case we are just targeting our own Service from the application Container, now we will try the other application in the namespace.*
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the Terminal window hit the up arrow to get the last command, edit the name and change application1 to application2, hit return at the end of the statement</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You should get the contents of a webpage. This is the output of the other application. This long format makes it easy to refer to other applications without having to leave and come back into the SDN (via a Route).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the terminal type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl http://application2:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>We can also connect to any of the Services hosted within the namespace/project by default</strong></p>
</div>
<div class="paragraph">
<p>Ask the person sat next to you what their project name is and make a note of it</p>
</div>
<div class="paragraph">
<p>In the terminal type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl http://application1.(the project name from the person next to you).svc.cluster.local:8080</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
OpenShift Container Platform can be installed with two different modes of SDN. The first is subnet, which exposes all Services in all Namespace/Projects to each other. This instance has a subnet SDN which is why you should be able to call other peoples Services directly from your own via the internal FQDN address.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="controlling-access-through-network-policies"><a class="anchor" href="#controlling-access-through-network-policies"></a>Controlling Access through Network Policies</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">Network Policies</div>
<div class="paragraph">
<p>OpenShift actually provides three distinct levels of information when it comes to logging:Historically OpenShift had two ways of setting up the SDN it used, the first being 'subnet', which made the SDN flat and every namespace/project visible by default to every other one, and 'Multitenant' which isolated every namespace with its own network ID. This was deemed to be too coarse a control, so the concept of 'Network Policies' was created. This allows for rules to be applied to any object within a namespace in terms of ingress and exgress.</p>
</div>
<div class="paragraph">
<p>By default when you create a project it is assigned some default policies that mirror the behaviour of the 'Multitenant' configuration, isolating the namespace. In this section we will remove those defaults and create some others to show the capabilities.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Click on 'Network/Network Policies'</p>
</div>
<div class="paragraph">
<p>For each of the policies listed click on the triple dot icon on the far right and choose ‘Delete Network Policy’.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/sdn-5.png" alt="Delete Network Policies">
</div>
</div>
<div class="paragraph">
<p>The Network Policy tab should display ‘No Network Policies Found’.</p>
</div>
<div class="paragraph">
<p>Go to Workloads/Pods, click on one of the application1 Pods, choose Terminal</p>
</div>
<div class="paragraph">
<p>Repeat the ‘curl’ command listed above for the person sat next to you, i.e. curl their application1</p>
</div>
<div class="paragraph">
<p>Ensure you get a webpage</p>
</div>
<div class="paragraph">
<p>Go to Network/Network Policies</p>
</div>
<div class="paragraph">
<p>Click on ‘Create Network Policy’</p>
</div>
<div class="paragraph">
<p>Enter the following - remember to change YOURNUMBERHERE to your user number</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
 name: example
 namespace: networktestYOURNUMBERHERE
spec:
 podSelector:
   matchLabels:
     app: application1
 ingress: []</code></pre>
</div>
</div>
<div class="paragraph">
<p>Click ‘Create’</p>
</div>
<div class="paragraph">
<p>Wait until the person next to you has done the same</p>
</div>
<div class="paragraph">
<p>Click on 'Workloads/Pods', click on one of the application1 Pods, choose Terminal</p>
</div>
<div class="paragraph">
<p>Repeat the ‘curl’ command listed above for the person sat next to you, i.e. curl their application1</p>
</div>
<div class="paragraph">
<p>The call will eventually fail - feel free to hit Ctrl-C to interrupt</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The creation of a Network Policy that prohibits ingress to the Application Service has stopped access to the Service from external namespaces AND internal Services.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on 'Workloads/Pods'</p>
</div>
<div class="paragraph">
<p>Click on the active pod for application2</p>
</div>
<div class="paragraph">
<p>Click on Terminal</p>
</div>
<div class="paragraph">
<p>Type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl http://application1:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>The call will eventually fail</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This shows that the Service is prohibited even from Services in its own namespace/project. This application of Network Policy allows for fine-grain control of traffic egress/ingress at the Service level. The other installation mode for SDN for OpenShift 4 is with Network Policies enabled, with default Network Policies providing a fully multitenanted environment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click on 'Projects'</p>
</div>
<div class="paragraph">
<p>On the triple dot icon on the far right for networktestxx select ‘Delete Project’</p>
</div>
<div class="paragraph">
<p>In the pop-up enter the name of the project (‘networktestxx’ with your number) and hit Delete</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="openshift-service-mesh-innovation"><a class="anchor" href="#openshift-service-mesh-innovation"></a>OpenShift Service Mesh [INNOVATION]</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Mark Roberts (feedback to <a href="mailto:mroberts@redhat.com">mroberts@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction-11"><a class="anchor" href="#introduction-11"></a>Introduction</h3>
<div class="paragraph">
<p>OpenShift is a platform that enables developers to deliver and manage extremely complex polyglot applications covering a variety of language runtimes and underlying technologies. However, OpenShift to date has not provided controls and monitoring regarding how each application component interacts with other components within an application or wider enterprise. This is where the Red Hat OpenShift Service Mesh adds value to the development and operations staff responsible for applications.</p>
</div>
<div class="paragraph">
<p>Red Hat OpenShift Service mesh is comprised of a number of separate open source projects that have been tested and integrated as a whole to deliver value to the OpenShift user. Each open source project breaks down further to specific named elements, some of which are encountered and described in the following workshop chapter.</p>
</div>
<div class="sect3">
<h4 id="istio"><a class="anchor" href="#istio"></a>Istio</h4>
<div class="paragraph">
<p>Istio is an implementation of the service-mesh and this component is responsible for the overall management of communication traffic between the elements of the application. The service mesh provides the manageable and measurable interaction between different services and enables teams to introduce new functionality and services in a controlled manner. One of the major benefits of the service-mesh is the fact that functionality such as Load balancing, resilience, security and observation is delivered by the mesh and not by the application. Application developers can focus in the value of their application and not how to add the resilience etc. to the application. In the earlier chapter on 'Application deployment strategies' users created a mechanism for blue/green deployments and A/B deployments to spread the load across different versions of services. These capabilities are extended further with Istio in terms of the basis for the rules that are used for traffic management. For a more detailed introduction to Istio please take a look at the free O&#8217;Reilly book 'Introducing Istio Service Mesh for Microservices' which can be downloaded from <a href="https://developers.redhat.com/books/introducing-istio-service-mesh-microservices/" target="_blank" rel="noopener">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="kiali"><a class="anchor" href="#kiali"></a>Kiali</h4>
<div class="paragraph">
<p>Kiali provides the observability capability to the Red Hat Service Mesh. This enables users to build a picture of service interaction, observe traffic and look in detail at the resources that are added to the OpenShift platform to create the operational service mesh. Kiali is used to understand the structure of the mesh and to gather metrics. A link is available to from Kiali to Jaeger for distributed tracing.</p>
</div>
</div>
<div class="sect3">
<h4 id="jaeger"><a class="anchor" href="#jaeger"></a>Jaeger</h4>
<div class="paragraph">
<p>Jaeger provides a detailed distributed traffic tracing capability. This shows accurately message interaction and enables teams to understand in detail the sequencing of traffic flow and to identify bottlenecks and weaknesses within the mesh.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-red-hat-service-mesh"><a class="anchor" href="#using-red-hat-service-mesh"></a>Using Red Hat Service Mesh</h3>
<div class="paragraph">
<p>The following workshop steps will show you how to create a service mesh using a simple application. The application communication will work perfectly fine with the use of OpenShift services and routes, and the introduction of the service mesh to provide more capable communication management will have no implications on the application code.</p>
</div>
<div class="paragraph">
<p>The application is called layers and it is a very simple Node JS REST interface that receives request either from an external curl command or from another version of itself. The application uses a number of environment variables that are set within the deployment yaml files. If the application instance has an environment variable called NEXT_LAYER_NAME then it will send a message to that layer. This continues down the layers of communication until an application instance is reached that does not have the environment variable. With each response the application returns its name, version identifier and IP address.</p>
</div>
<div class="sect3">
<h4 id="create-a-new-project-for-the-service-mesh-activity"><a class="anchor" href="#create-a-new-project-for-the-service-mesh-activity"></a>Create a new project for the service mesh activity</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-project service-mesh-X</code></pre>
</div>
</div>
<div class="paragraph">
<p>(Where X is your user number)</p>
</div>
<div class="paragraph">
<p>Not all projects are required to be managed by service mesh. As a result you need to add the project that you just created to the service mesh control plane so that the sidecar containers will be injected into the pods. We will be using some preloaded assets in the Terminal window, so enter the following command to set the context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/attendee/service-mesh</code></pre>
</div>
</div>
<div class="paragraph">
<p>To add the current project as a service mesh member within the control plane called 'istio-system' execute the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f servicemeshmember.yaml</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="phase-1-initial-application"><a class="anchor" href="#phase-1-initial-application"></a>Phase 1 - Initial application</h3>
<div class="paragraph">
<p>The micro-service based application that you are about to create is very simple and uses a rest interface that can be asked to call another downstream version of itself. This can continue for as many application instances as needed to illustrate the features of the service mesh.</p>
</div>
<div class="paragraph">
<p>To create the first application instance do the following :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd phase1
oc create -f layer1.yaml --save-config</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch to the web user interface and select the developer view for your current project. Select the topology view and you will see the application start to be created. Click on the centre of the blue circle for the application and you should see the fly out menu on the right with details of the service and the running pod. Select the pod and scroll down the details of the pod until you see a section titled 'Containers'. This should show two containers as indicated below which are the 'layers' application container and the Istio sidecar container.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/service-mesh-01.png" alt="Pod with application container and sidecar container">
</div>
</div>
<div class="paragraph">
<p>Expose the service using a route by executing the following command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc expose service/layer1</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point the application has all of the components required for network communication without the use of Istio. The resources required that exist can be viewed with the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get all</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will list the following resources :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>deployment</p>
</li>
<li>
<p>pod</p>
</li>
<li>
<p>replicaset</p>
</li>
<li>
<p>service</p>
</li>
<li>
<p>route</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The route, service and pod are shown in the diagram below to indicate the network communication to the application.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/service-mesh-02.png" alt="Route" width="service and application">
</div>
</div>
<div class="paragraph">
<p>Communication to the application will work as expected using the above resources. This can be tested by pasting the following command into the terminal window to make 100 calls to the application, approximately ever 0.2 seconds.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>export ROUTE=$(oc get route -o jsonpath='{.items[0].spec.host}{"/call-layers"}')
for i in {1..100}; do curl $ROUTE; echo ""; sleep .2;done</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="adding-istio-capability"><a class="anchor" href="#adding-istio-capability"></a>Adding Istio capability</h4>
<div class="paragraph">
<p>To enable the service mesh communication requires further resources to be created. The initial resources to be created are the gateway and the virtual service. The gateway resource identifies a host for which communication should be intercepted and directed to the istio-ingress gateway. The virtual service  acts as a communication director selecting traffic that matches specific criteria for routing to a destination service. The gateway and virtual service yaml content is shown in the diagram below which also shows schematically how the communication is directed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/service-mesh-03.png" alt="Istio gateway and virtual service">
</div>
</div>
<div class="paragraph">
<p>Create the gateway and the virtual service with the commands below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f gateway-layer1.yaml
oc create -f virtual-service-layer1.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="view-the-istio-related-resources"><a class="anchor" href="#view-the-istio-related-resources"></a>View the istio related resources</h4>
<div class="paragraph">
<p>The oc command 'oc get all' is often used to generate a list of all resources within a project. This is fine for listing the deployment configurations, services, replicasets and pods but it does not list the resources used to manage the service mesh. To view the istio related resources use the command below :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get istio-io</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command will list the gateway and the virtual service. The virtual service also shows the gateway to which it relates and the hosts for which it is controlling traffic as shown in the example below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME                                        GATEWAYS           HOSTS                                                        AGE
virtualservice.networking.istio.io/layers   [layer1-gateway]   [layer1-layers.apps.cluster-c2d5.c2d5.example.opentlc.com]   54s

NAME                                         AGE
gateway.networking.istio.io/layer1-gateway   63s</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="service-mesh-visualisation-with-kiali"><a class="anchor" href="#service-mesh-visualisation-with-kiali"></a>Service mesh visualisation with Kiali</h3>
<div class="paragraph">
<p>Red Hat Service mesh includes a component called Kiali which provides a visualization of the components of the mesh to assist in monitoring and managing the communication processes within a micro-service based application. To find the URL for the Kiali web application enter the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>echo "kiali-istio-system."$(oc whoami --show-console=true | cut -d'.' -f2-7)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will create the URL for the Kiali system in use within the cluster. Open this URL in a new browser tab.</p>
</div>
<div class="paragraph">
<p>Press the blue 'Log In With OpenShift' button to authenticate with your OpenShift credentials and then select the blue '1 application' link in the box labelled with your service-mesh-XX project.</p>
</div>
<div class="paragraph">
<p>On the left hand side of the Kiali screen select 'Graph and you should see a screen similar to that shown below :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/service-mesh-04.png" alt="Kiali initial screen">
</div>
</div>
<div class="paragraph">
<p>If your screen shows application nodes and services then Kiali is responding to the traffic that was sent in the 100 calls to the application a few minutes ago. Kiali will display a discovered configuration of applications and services if there has been traffic for it to observe.</p>
</div>
<div class="paragraph">
<p>If the Kiali view has timed out and removed the discovered services oyu will see a screen identical to that which is shown above. In that case press the blue button with the text 'Display unused nodes' and you will see the nodes and services of the application.</p>
</div>
<div class="paragraph">
<p>You will now see the layer-1 application which is broken out as the service (dotted triangle) and the application (dotted square). Press the legend button to see the key to the objects in the browser window. You will also see that the service has an Istio virtual service associated with it.</p>
</div>
<div class="paragraph">
<p>Press the display drop down menu at the top of the screen and select the traffic animation option. Back at the terminal window start sending traffic to the service again using the for loop shell script used previously (and repeated below) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>for i in {1..100}; do curl $ROUTE; echo ""; sleep .2;done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch back to the Kiali window and watch the animation of the traffic flow in the graph. It will take a few seconds for the animation to start, but eventually you will see a screen similar to that which is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/service-mesh-05.png" alt="Kiali traffic animation">
</div>
</div>
<div class="paragraph">
<p>Kiali has a number of sources of information which are selected from the left hand side menu. The animation display is shown on the graph view. If the for loop to send requests to the application has ended then restart it and you may want to change the number of calls to 1000 and change the sleep delay to 0.5 or 1.0 seconds to give more traffic while you explore the user interface.</p>
</div>
<div class="paragraph">
<p>On the Kiali graph view click on the service (triangle) for layer1 and you will see information about the service on the right hand side panel. The panel shows information about the messages entering and leaving the service. Click on the application for layer1, identified as v1 (square) and the right hand side panel changes to display information about the application which only has inbound traffic.</p>
</div>
<div class="paragraph">
<p>The top menu of the Graph screen has a number of different viewing modes. The first drop down menu allows users to display information on different versions of applications, to only show services or to display the workloads. The versioned application graph is particularly useful as it groups multiple versions of applications together along with their associated services.</p>
</div>
<div class="paragraph">
<p>The second drop down menu allows for the display of requests per second, request percentage and response time on each communication line. The request percentage is particularly useful when splitting traffic between versions later.</p>
</div>
<div class="paragraph">
<p>The third drop down menu allows users to select which objects to display on the main screen.</p>
</div>
<div class="paragraph">
<p>On the left hand side of the Kiali screen there are options to display information about applications, workloads and services. These displays show useful information on the health of the resource. The Istio Config menu shows information about the istio resources (virtual services, gateways and many other Istio related resources). This is a useful source of information if something is wrong in the configuration of a resource as it will be highlighted clearly as shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/service-mesh-06.png" alt="Virtual service with error">
</div>
</div>
</div>
<div class="sect2">
<h3 id="phase-2-further-content-in-the-communication-chain"><a class="anchor" href="#phase-2-further-content-in-the-communication-chain"></a>Phase 2 - Further content in the communication chain</h3>
<div class="paragraph">
<p>The next phase of building the service mesh is to introduce another application and service.</p>
</div>
<div class="paragraph">
<p>Change directory to phase 2 and create the new application for layer 2 with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd ../phase2
oc create -f layer2.yaml --save-config</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the topology view of the web user interface you will see that two deployments are created for the two different versions of layer2, with two pods for each application.</p>
</div>
<div class="paragraph">
<p>Create the additional virtual service for the component with the commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f virtual-service-layer2.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reconfigure layer1 to send messages to layer2 using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc apply -f layer1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch to the OpenShift browser window and ensure that you are using the developer mode on the top left corner, you have the service-mesh-XX project selected and you are viewing the Topology view. You should see the 'layers' application grouping with layer1-v1 and layer2 (with versions v1 and v2) grouped together within the application group. Click on layer1-v1 and you will see on the fly-out window on the right hand side that it has one pod. This pod contains the running application container and the istio sidecar container too. If you select one of the layer 2 applications you will see that it has 2 replica pods as directed by the layer2.yaml deployment file.</p>
</div>
<div class="paragraph">
<p>In the OpenShift terminal window restart the for loop to start sending http requests to layer1. You should now see that layer1 is sending requests on to layer 2 and you should see the IP address of the nodes on which those two layers are running as shown below. This also shows the distribution of traffic to the different versions of layer2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>"layer1 (v1) [10.128.3.13] ----&gt; layer2 (v1) [10.130.3.146]"
"layer1 (v1) [10.128.3.13] ----&gt; layer2 (v2) [10.130.3.147]"
"layer1 (v1) [10.128.3.13] ----&gt; layer2 (v1) [10.131.1.184]"
"layer1 (v1) [10.128.3.13] ----&gt; layer2 (v2) [10.128.3.12]"
"layer1 (v1) [10.128.3.13] ----&gt; layer2 (v1) [10.130.3.146]"
"layer1 (v1) [10.128.3.13] ----&gt; layer2 (v2) [10.130.3.147]"
"layer1 (v1) [10.128.3.13] ----&gt; layer2 (v1) [10.131.1.184]"</code></pre>
</div>
</div>
<div class="paragraph">
<p>In most micro-service based applications messages will not conveniently display application versions or IP addresses as in this example application. Consequently Kiali visualization is very important to show what actually happens in the 'real world'.</p>
</div>
<div class="paragraph">
<p>Switch to the Kiali browser view and select the graph view. Wait until the traffic starts to appear. You may see some extraneous traffic going to nodes that are not in the current project namespaces. These are genuine messages being send to the Istio system to provide the monitoring capability. To hide the unwanted nodes use a filter in the 'Hide' text field at the top of the graph and use a filter of "namespace!=service-mesh-XX". Replace XX with your user number and do not include quote characters.</p>
</div>
<div class="paragraph">
<p>The Kiali graph view (shown below) is currently displaying the communication into layer 1 and then from layer 1 to layer 2. Layer 2 has a virtual service which is governing the conditions under which layer 2 will get any network traffic such as protocol filtering, path filtering etc. In the absence of a destination rule to govern the flow of traffic a (roughly) 50% - 50% split of traffic is seen between version 1 and version 2 of layer 2. Select "Request percentage" in the second dropdown menu to see the distribution to version 1 and version 2 of layer2. Restart the for loop to send traffic in the terminal window if necessary.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/service-mesh-07.png" alt="Kiali distribution of traffic to layer 2">
</div>
</div>
</div>
<div class="sect2">
<h3 id="phase-3-further-multi-versioned-applications-in-the-communication-chain"><a class="anchor" href="#phase-3-further-multi-versioned-applications-in-the-communication-chain"></a>Phase 3 - Further multi-versioned applications in the communication chain</h3>
<div class="paragraph">
<p>The next phase of building the service mesh is to introduce another multi-versioned application and service.</p>
</div>
<div class="paragraph">
<p>Change directory to phase 3 and create the new application for layer 3 with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd ../phase3
oc create -f layer3.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see that four deployments are created for the four different versions of layer3.</p>
</div>
<div class="paragraph">
<p>Switch to the OpenShift browser window and ensure that you are using the developer mode on the top left corner, you have the service-mesh-XX project selected and you are viewing the Topology view. You should see the 'layers' application grouping now has six micro-services within it. This is shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/service-mesh-08.png" alt="OpenShift topology view of micro-services">
</div>
</div>
<div class="paragraph">
<p>Under more common circumstances of a development project then names will often be cryptic and it will be hard to gain any understanding of the communication logic, sequence or hierarchy of an overall application. This is when the Kiali visualization view becomes extremely useful.</p>
</div>
<div class="paragraph">
<p>To tie the service mesh together for the different versions of layer3 a virtual service and a destination rule will be used.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Virtual Services and Destination Rules</div>
<div class="paragraph">
<p>Virtual services and destination rules work hand-in-hand to define the routing of traffic. The virtual service is evaluated first and decides how to route traffic to a specific destination and then the destination rule is used to direct the traffic for the identified destination. The virtual service used in this phase is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: layer3
spec:
  hosts:
  - layer3
  http:
  - match:
    - uri:
        exact: /call-layers
    - uri:
        exact: /get-info
    - uri:
        exact: /
  - route:
    - destination:
        host: layer3
        subset: v1
      weight: 50
    - destination:
        host: layer3
        subset: v2
      weight: 30
    - destination:
        host: layer3
        subset: v3
      weight: 20</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above will direct http traffic with the uri path of /call-layers, /get-info or / sent to application layer3 (spec: &#8594; hosts: &#8594; layer3) to the destinations subset v1 (50% of traffic), subset v2 (30% of traffic) and subset v3 (20% of traffic). At the present time no traffic is directed to subset v4.</p>
</div>
<div class="paragraph">
<p>The destination rule associated with the above virtual service is shown below which ties the subsets shown in the virtual service to the specific versions of the applications :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: layer3
spec:
  host: layer3
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v3
    labels:
      version: v3</code></pre>
</div>
</div>
<div class="paragraph">
<p>The destination rule defines to where the different subsets will direct traffic. Subset v1 directs traffic to the pod with the label v1 and subset v2 directs traffic to the pod with the label v2 etc.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The command below will display all pods and the labels defined on them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pods -o jsonpath='{range.items[*]}{.metadata.name}{"  "}{.metadata.labels.version}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of the above command will be similar to that shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>layer1-v1-5cdbdc64bc-hbm77  v1
layer2-v1-747594d6d9-rd586  v1
layer2-v1-747594d6d9-wlrhr  v1
layer2-v2-7f8b4674cc-vbvt9  v2
layer2-v2-7f8b4674cc-zs9lk  v2
layer3-v1-85db7f87c6-rdz8c  v1
layer3-v2-5649897bbf-6f99m  v2
layer3-v3-769cfb5446-jcs4v  v3
layer3-v4-858765c8c9-m5lzf  v4</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above shows that there is 1 version for layer1, 2 versions for layer 2 that are replicated pods (two instances) and 4 versions for layer 3.</p>
</div>
<div class="paragraph">
<p>Destination rules require a virtual services and there cannot be more destinations than virtual services. For this reason when a destination rule is used the virtual service is either created at the same time or the virtual service already exists.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f destination-rule-virtual-service-layer3.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the previous test it was seen that there was a 50% - 50% distribution of traffic going into layer 2. The command below will introduce a destination rule and add a distribution clause to the virtual service for layer 2 to distribute the traffic  80% to 20% in favour of version 1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc apply -f destination-rule-virtual-service-layer2.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reconfigure layer2 to send messages to layer3 using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc apply -f layer2.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the OpenShift terminal window recall the for loop that sends messages to the applications and change the total number of messages to 200 and the sleep value from .2 to .5. This will give more time to explore the traffic in Kiali. Execute the command when the changes have been made. You should now see that layer1 is sending requests on to layer 2 which is sending requests on to layer 3 and you should see the IP address of the nodes on which those two layers are running as shown below. You will also see a distribution of workload across layer 3 v1, v2 and v3 in the percentages defined in the virtual service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v3 (v3) [10.128.2.144]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v1 (v1) [10.128.2.143]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v1 (v1) [10.128.2.143]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v1 (v1) [10.128.2.143]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v2 (v2) [10.128.2.145]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v1 (v1) [10.128.2.143]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v2 (v2) [10.128.2.145]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v1 (v1) [10.128.2.143]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v1 (v1) [10.128.2.143]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v1 (v1) [10.128.2.143]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v2 (v2) [10.128.2.145]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v1 (v1) [10.128.2.143]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v2 (v2) [10.128.2.145]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v2 (v2) [10.128.2.145]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v3 (v3) [10.128.2.144]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v2 (v2) [10.128.2.145]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v3 (v3) [10.128.2.144]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v2 (v2) [10.128.2.145]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v1 (v1) [10.128.2.143]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v2 (v2) [10.128.2.145]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v3 (v3) [10.128.2.144]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v3 (v3) [10.128.2.144]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v1 (v1) [10.128.2.143]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v3 (v3) [10.128.2.144]"
"layer1 (v1) [10.130.2.240] ----&gt; layer2 (v1) [10.128.2.151] ----&gt; layer3-v3 (v3) [10.128.2.144]"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of the above 25 calls, 10 are for v1 (40%), 8 are for v2 (32%) and 7 are for v3 (28%). The distribution percentages become more accurate the more messages are sent. When more calls are made the distribution gets closer to the desired values.</p>
</div>
<div class="paragraph">
<p>Switch to the Kiali browser view and wait until the traffic starts to appear. On the second to left drop down option menu at the top of the Kiali screen select the option "Requests percentage". This will show the breakdown of traffic similar to that which is shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/service-mesh-09.png" alt="OpenShift topology view of micro-services">
</div>
</div>
</div>
<div class="sect2">
<h3 id="phase-4-service-timeout"><a class="anchor" href="#phase-4-service-timeout"></a>Phase 4 - Service timeout</h3>
<div class="paragraph">
<p>The service mesh has a capability to manage traffic flow in a number of different ways. This includes a circuit breaker function to remove applications from participation in communication and a timeout function to control the abandonment of communication with a service, to name just two. In this phase a timeout will be introduced to control the traffic flow such that version A of the application layer will force a timeout after 1.5 second and version B will force a timeout after 1 seconds.</p>
</div>
<div class="paragraph">
<p>Change directory to phase 3 and create the new applications for layers 2A and 2B with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd ../phase4
oc create -f layer2-A.yaml --save-config
oc create -f layer2-B.yaml --save-config</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the virtual service and destination rule for each of the new applications. The destination rule and virtual service for application 2A is shown below :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: layer2-a
spec:
  host: layer2-a
  subsets:
  - name: inst-1
    labels:
      instance: instance1
  - name: inst-2
    labels:
      instance: instance2
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: layer2-a
spec:
  hosts:
  - layer2-a
  http:
  - match:
    - uri:
        prefix: /call-layers
    - uri:
        exact: /get-info
    - uri:
        exact: /
    route:
    - destination:
        host: layer2-a
        port:
          number: 8080
        subset: inst-1
      weight: 80
    - destination:
        host: layer2-a
        port:
          number: 8080
        subset: inst-2
      weight: 20
    timeout: 1.500s</code></pre>
</div>
</div>
<div class="paragraph">
<p>The virtual service shows a traffic distribution of 80 % to inst-1 and 20% to inst-2. The final statement shows the timeout that applies to the entire route of 1.5 seconds.</p>
</div>
<div class="paragraph">
<p>A similar configuration applies to the virtual service and destination rules for application 2-B with a distribution of 30% to 70% and a timeout of 1 second.</p>
</div>
<div class="paragraph">
<p>Create the virtual services and destination rules with the commands :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f destination-rule-virtual-service-layer2-A.yaml --save-config
oc create -f destination-rule-virtual-service-layer2-B.yaml --save-config</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify layer 1 application so that it sends traffic to applications 2A and 2B.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc apply -f layer1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the OpenShift terminal window recall the for loop that sends messages to the applications and execute it again.</p>
</div>
<div class="paragraph">
<p>You should now see that layer1 is sending requests on to layer 2a (instances 1 and 2) and to layer 2b (instances 1 and 2) Take a look at the graph in Kiali and you will also see a distribution of workload across layer 2 in the percentages defined in the virtual service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>layer1 (v1) [10.128.2.62] ----&gt; layer2-a (instance-2) [10.128.2.60]
layer1 (v1) [10.128.2.62] ----&gt; layer2-a (instance-1) [10.128.2.59]
layer1 (v1) [10.128.2.62] ----&gt; layer2-a (instance-1) [10.128.2.59]
layer1 (v1) [10.128.2.62] ----&gt; layer2-b (instance-1) [10.128.2.61]
layer1 (v1) [10.128.2.62] ----&gt; layer2-b (instance-2) [10.131.0.86]
layer1 (v1) [10.128.2.62] ----&gt; layer2-a (instance-2) [10.128.2.60]
layer1 (v1) [10.128.2.62] ----&gt; layer2-a (instance-2) [10.128.2.60]</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="introducing-application-delay"><a class="anchor" href="#introducing-application-delay"></a>Introducing application delay</h4>
<div class="paragraph">
<p>To show the impact of the timeout function a different rest endpoint is used. Reconfigure the ROUTE environment variable to use the alternative endpoint with the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>export ROUTE=$(oc get route -o jsonpath='{.items[0].spec.host}{"/call-layers-sleep"}')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Call the applications with a delay of 900ms. This should result in no interruption to service. Execute the following shell command to make 100 calls.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>for i in {1..100}; do curl $ROUTE:900; echo "";done</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will result in a display similar to that which is shown below. Instances 1 and 2 of layers 2a and 2b are responding.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>layer1 (v1) [10.128.2.62] sleep (900 ms) ----&gt; layer2-b (instance-1) [10.128.2.61] sleep (900 ms)
layer1 (v1) [10.128.2.62] sleep (900 ms) ----&gt; layer2-a (instance-1) [10.128.2.59] sleep (900 ms)
layer1 (v1) [10.128.2.62] sleep (900 ms) ----&gt; layer2-b (instance-2) [10.131.0.86] sleep (900 ms)
layer1 (v1) [10.128.2.62] sleep (900 ms) ----&gt; layer2-b (instance-1) [10.128.2.61] sleep (900 ms)
layer1 (v1) [10.128.2.62] sleep (900 ms) ----&gt; layer2-b (instance-2) [10.131.0.86] sleep (900 ms)
layer1 (v1) [10.128.2.62] sleep (900 ms) ----&gt; layer2-a (instance-1) [10.128.2.59] sleep (900 ms)
layer1 (v1) [10.128.2.62] sleep (900 ms) ----&gt; layer2-a (instance-1) [10.128.2.59] sleep (900 ms)
layer1 (v1) [10.128.2.62] sleep (900 ms) ----&gt; layer2-b (instance-2) [10.131.0.86] sleep (900 ms)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Increase the delay to 1100 ms using the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>for i in {1..100}; do curl $ROUTE:1100; echo "";done</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will result in a display similar to that which is shown below. Instances 1 and 2 of layers 2a are responding, while the delayed response from instances 1 and 2 of layer 2b are being timed out.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>layer1 (v1) [10.128.2.62] sleep (1100 ms) ----&gt; upstream request timeout
layer1 (v1) [10.128.2.62] sleep (1100 ms) ----&gt; layer2-a (instance-1) [10.128.2.59] sleep (1100 ms)
layer1 (v1) [10.128.2.62] sleep (1100 ms) ----&gt; upstream request timeout
layer1 (v1) [10.128.2.62] sleep (1100 ms) ----&gt; upstream request timeout
layer1 (v1) [10.128.2.62] sleep (1100 ms) ----&gt; layer2-a (instance-1) [10.128.2.59] sleep (1100 ms)
layer1 (v1) [10.128.2.62] sleep (1100 ms) ----&gt; layer2-a (instance-2) [10.128.2.60] sleep (1100 ms)
layer1 (v1) [10.128.2.62] sleep (1100 ms) ----&gt; layer2-a (instance-2) [10.128.2.60] sleep (1100 ms)
layer1 (v1) [10.128.2.62] sleep (1100 ms) ----&gt; layer2-a (instance-1) [10.128.2.59] sleep (1100 ms)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Increase the delay to 1600 ms using the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>for i in {1..100}; do curl $ROUTE:1600; echo "";done</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will result in a display similar to that which is shown below in which all calls are being timed out.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>layer1 (v1) [10.128.2.62] sleep (1100 ms) ----&gt; upstream request timeout
layer1 (v1) [10.128.2.62] sleep (1100 ms) ----&gt; upstream request timeout</code></pre>
</div>
</div>
<div class="paragraph">
<p>While the for loop is running make a change to the timeout of one of the virtual services to increase the delay to 2500 ms. This can be done in two different ways.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make a change to one the virtual service files using the vi editor and then re-apply the virtual service using the following :</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi destination-rule-virtual-service-layer2-A.yaml
oc apply -f destination-rule-virtual-service-layer2-A.yaml

or

vi destination-rule-virtual-service-layer2-B.yaml
oc apply -f destination-rule-virtual-service-layer2-B.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively use the Kiali browser window, switch to the istio-config section on the left hand side and select the virtual service for either layer2-A or layer2-A. Edit the yaml within the window to alter the timeout value and save the changes. One of the good things about using this editor is the immediate validation of the yaml code.</p>
</div>
<div class="paragraph">
<p>Observe that traffic starts to be allowed through to that application only.</p>
</div>
<div class="paragraph">
<p>Take a look at the traffic flow in the graph view of Kiali and you should see a display similar to that which is shown below (once Kiali has had the opportunity to catch up).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/service-mesh-10.png" alt="Traffic distribution with errors">
</div>
</div>
<div class="paragraph">
<p>The above image shows red to indicate the communication that is being rejected by the timeout.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cleaning-up-4"><a class="anchor" href="#cleaning-up-4"></a>Cleaning up</h3>
<div class="paragraph">
<p>To tidy up the cluster now that the chapter is complete please use the command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc delete project service-mesh-XX</code></pre>
</div>
</div>
<div class="paragraph">
<p>_where XX is your user ID number.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0.0<br>
Last updated 2020-07-13 14:21:53 +0100
</div>
</div>
</body>
</html>